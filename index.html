<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis Voice Assistant</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        /* --- FUTURISTIC UI --- */
        body {
            margin: 0;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace; /* Tech vibe */
            background-color: #000;
            color: #0f0; /* Matrix Green */
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
        }

        /* The "Eye" of the AI */
        .arc-reactor {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 2px solid #0f0;
            box-shadow: 0 0 20px #0f0, inset 0 0 20px #0f0;
            margin-top: 20vh;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arc-reactor:active { transform: scale(0.95); }
        .arc-reactor.listening { 
            animation: pulse 1.5s infinite; 
            background: rgba(0, 255, 0, 0.1);
        }
        
        .core {
            width: 80px;
            height: 80px;
            background: #0f0;
            border-radius: 50%;
            opacity: 0.2;
            filter: blur(5px);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px #0f0; }
            50% { box-shadow: 0 0 50px #0f0, 0 0 20px #fff; }
            100% { box-shadow: 0 0 20px #0f0; }
        }

        /* Text Displays */
        #status { margin-top: 20px; font-size: 1.2rem; letter-spacing: 2px; }
        #transcript { 
            font-size: 0.9rem; color: #fff; margin-top: 10px; 
            min-height: 20px; text-transform: none; 
        }

        /* Action Buttons Area */
        .controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .btn {
            background: transparent;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 25px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #0f0; color: #000; box-shadow: 0 0 15px #0f0; }

        /* Modal for Adding Contacts */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .input-group { margin: 10px 0; text-align: center; }
        input {
            background: #111; border: 1px solid #333; color: #fff;
            padding: 10px; font-family: inherit; width: 250px; text-align: center;
        }
        input:focus { border-color: #0f0; outline: none; }

    </style>
</head>
<body>

    <div id="status">SYSTEM ONLINE</div>
    
    <div class="arc-reactor" onclick="toggleListening()" id="reactor">
        <div class="core"></div>
    </div>

    <div id="transcript">Tap circle to speak...</div>

    <div class="controls">
        <button class="btn" onclick="trySyncContacts()">SYNC CONTACTS</button>
        <button class="btn" onclick="showAddContactModal()">+ ADD MANUAL</button>
    </div>

    <div id="modal">
        <h2 style="color:white;">NEW ENTRY</h2>
        <div class="input-group">
            <input type="text" id="newName" placeholder="Name (e.g. Mike)">
        </div>
        <div class="input-group">
            <input type="tel" id="newPhone" placeholder="Phone (e.g. 0712...)">
        </div>
        <br>
        <button class="btn" onclick="saveNewContact()">SAVE TO APP</button>
        <br><br>
        <button class="btn" onclick="downloadVCard()">ðŸ“² SAVE TO DEVICE</button>
        <br><br>
        <button class="btn" style="border-color:#555; color:#777;" onclick="closeModal()">CANCEL</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const reactor = document.getElementById('reactor');
        const statusDisplay = document.getElementById('status');
        const transcriptDisplay = document.getElementById('transcript');
        const modal = document.getElementById('modal');

        // Load saved contacts or empty array
        let myContacts = JSON.parse(localStorage.getItem('jarvis_contacts') || '[]');

        // Setup Speech Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; 
        recognition.interimResults = false;

        // --- SPEECH LOGIC ---
        
        function toggleListening() {
            try {
                recognition.start();
                reactor.classList.add('listening');
                statusDisplay.textContent = "LISTENING...";
            } catch (e) {
                // If already started, stop it
                recognition.stop();
            }
        }

        recognition.onend = () => {
            reactor.classList.remove('listening');
            statusDisplay.textContent = "PROCESSING";
            setTimeout(() => statusDisplay.textContent = "SYSTEM ONLINE", 2000);
        };

        recognition.onresult = (event) => {
            const command = event.results[0][0].transcript.toLowerCase();
            transcriptDisplay.textContent = `"${command}"`;
            handleCommand(command);
        };

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            // Try to pick a specific voice if available (optional)
            const voices = window.speechSynthesis.getVoices();
            utterance.rate = 1.1; // Slightly faster
            window.speechSynthesis.speak(utterance);
        }

        // --- INTELLIGENCE ---

        function handleCommand(cmd) {
            // 1. CALL COMMAND
            if (cmd.includes('call') || cmd.includes('dial')) {
                const name = cmd.replace('call', '').replace('dial', '').trim();
                const contact = findContact(name);
                
                if (contact) {
                    speak(`Calling ${contact.name}`);
                    setTimeout(() => window.location.href = `tel:${contact.phone}`, 1500);
                } else {
                    speak(`I couldn't find ${name}. Would you like to add them?`);
                    // Auto open modal with name pre-filled
                    document.getElementById('newName').value = capitalize(name);
                    showAddContactModal();
                }
                return;
            }

            // 2. WHATSAPP COMMAND
            if (cmd.includes('message') || cmd.includes('text')) {
                // Simple parser: "Message Brian saying hello"
                const namePart = cmd.split(' ')[1]; // Very basic, assumes name is 2nd word
                const contact = findContact(namePart);

                if (contact) {
                    speak(`Opening WhatsApp for ${contact.name}`);
                    window.open(`https://wa.me/${contact.phone}`, '_blank');
                } else {
                    speak("Contact not found.");
                }
                return;
            }

            speak("Command not recognized.");
        }

        function findContact(name) {
            // Fuzzy search (checks if stored name includes the spoken name)
            return myContacts.find(c => c.name.toLowerCase().includes(name.toLowerCase()));
        }

        // --- CONTACT MANAGEMENT ---

        async function trySyncContacts() {
            // Feature Detection
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contacts = await navigator.contacts.select(props, opts);
                    
                    if (contacts.length) {
                        // Add to our internal list
                        contacts.forEach(c => {
                            myContacts.push({ name: c.name[0], phone: c.tel[0] });
                        });
                        saveToStorage();
                        speak(`Synced ${contacts.length} contacts.`);
                    }
                } catch (ex) {
                    // User cancelled or error
                    statusDisplay.textContent = "SYNC CANCELLED";
                }
            } else {
                // Fallback for iPhone/Desktop
                alert("Contact Picker not supported on this device. Opening manual add form.");
                showAddContactModal();
            }
        }

        function showAddContactModal() {
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function saveNewContact() {
            const name = document.getElementById('newName').value;
            const phone = document.getElementById('newPhone').value;

            if (name && phone) {
                myContacts.push({ name: name, phone: phone });
                saveToStorage();
                speak(`${name} saved to app memory.`);
                closeModal();
                // Clear inputs
                document.getElementById('newName').value = '';
                document.getElementById('newPhone').value = '';
            } else {
                alert("Please enter both name and number");
            }
        }

        // --- NEW FEATURE: SAVE TO DEVICE (vCard) ---
        function downloadVCard() {
            const name = document.getElementById('newName').value;
            const phone = document.getElementById('newPhone').value;

            if(!name || !phone) { alert("Enter details first"); return; }

            // Create vCard content
            const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${name}
TEL;TYPE=CELL:${phone}
END:VCARD`;

            const blob = new Blob([vcard], { type: "text/vcard" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.vcf`;
            a.click();
            
            speak("Opening contacts app to save.");
        }

        function saveToStorage() {
            localStorage.setItem('jarvis_contacts', JSON.stringify(myContacts));
        }
        
        function capitalize(s) {
            return s && s[0].toUpperCase() + s.slice(1);
        }

    </script>
</body>
</html>
