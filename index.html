<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0c29">
    <style>
        /* Modern Glassmorphism UI */
        body {
            margin: 0;
            height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        h1 { font-weight: 300; letter-spacing: 2px; margin-bottom: 0.5rem; }
        p { color: #aaa; font-size: 0.9rem; }

        /* The AI Orb Animation */
        .orb-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 2rem auto;
            cursor: pointer;
        }

        .orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff00cc, #333399);
            box-shadow: 0 0 20px #ff00cc, 0 0 40px #333399;
            animation: breathe 3s infinite ease-in-out;
            transition: all 0.3s;
        }

        .orb.listening {
            transform: scale(1.1);
            box-shadow: 0 0 40px #00d4ff, 0 0 60px #00d4ff;
            background: linear-gradient(45deg, #00d4ff, #005bea);
            animation: pulse 1s infinite;
        }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        /* Action Buttons */
        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 10px 20px;
            color: white;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.3s;
            font-size: 0.8rem;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }

        #output { margin-top: 1rem; font-style: italic; min-height: 20px; }
        
        /* Hidden elements used for logic */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="glass-panel">
        <h1>A.I. ASSISTANT</h1>
        <p>Tap the Orb to Speak</p>

        <div class="orb-container" onclick="toggleListening()">
            <div id="orb" class="orb"></div>
        </div>

        <div id="output">Ready...</div>

        <button class="btn" onclick="syncContacts()">üìÇ Sync Contacts from Phone</button>
        <br>
        <button class="btn" onclick="installApp()" id="installBtn" style="display:none;">‚¨áÔ∏è Install App</button>
    </div>

    <script>
        // --- 1. SETUP & VARIABLES ---
        const orb = document.getElementById('orb');
        const output = document.getElementById('output');
        let savedContacts = JSON.parse(localStorage.getItem('myContacts') || '[]');
        
        // Check for Speech Recognition Support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;

        // --- 2. VOICE LOGIC (THE BRAIN) ---
        recognition.onstart = () => {
            orb.classList.add('listening');
            output.textContent = "Listening...";
        };

        recognition.onend = () => {
            orb.classList.remove('listening');
        };

        recognition.onresult = (event) => {
            const command = event.results[0][0].transcript.toLowerCase();
            output.textContent = `"${command}"`;
            processCommand(command);
        };

        function toggleListening() {
            try { recognition.start(); } catch(e) { recognition.stop(); }
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }

        // --- 3. INTELLIGENCE & COMMANDS ---
        function processCommand(cmd) {
            // INTENT: CALL
            if (cmd.includes('call') || cmd.includes('dial')) {
                const name = cmd.replace('call', '').replace('dial', '').trim();
                findAndCall(name);
                return;
            }

            // INTENT: WHATSAPP
            if (cmd.includes('whatsapp') || cmd.includes('message')) {
                // Try to split "Message John saying hello"
                const parts = cmd.split(/saying|that/);
                const namePart = parts[0].replace('message', '').replace('whatsapp', '').trim();
                const msgPart = parts[1] ? parts[1].trim() : "Hi";
                
                findAndMessage(namePart, msgPart);
                return;
            }

            // INTENT: TIME
            if (cmd.includes('time')) {
                const time = new Date().toLocaleTimeString();
                speak(`It is currently ${time}`);
                output.textContent = time;
                return;
            }

            // INTENT: BATTERY
            if (cmd.includes('battery')) {
                checkBattery();
                return;
            }

            // INTENT: SEARCH
            if (cmd.includes('search for') || cmd.includes('google')) {
                const query = cmd.replace('search for', '').replace('google', '').trim();
                speak(`Searching Google for ${query}`);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
                return;
            }

            speak("I didn't catch that.");
        }

        // --- 4. CONTACT FUNCTIONS ---
        async function syncContacts() {
            // Uses the Native Contact Picker API
            const props = ['name', 'tel'];
            const opts = { multiple: true };

            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const contacts = await navigator.contacts.select(props, opts);
                    if(contacts.length > 0) {
                        // Normalize and save
                        const newContacts = contacts.map(c => ({
                            name: c.name[0],
                            phone: c.tel[0]
                        }));
                        // Merge with existing
                        savedContacts = [...savedContacts, ...newContacts];
                        localStorage.setItem('myContacts', JSON.stringify(savedContacts));
                        speak(`Successfully synced ${contacts.length} contacts.`);
                    }
                } else {
                    alert('Contact Picker not supported on this device/browser. Try Chrome on Android.');
                }
            } catch (ex) {
                console.log(ex);
                output.textContent = "Sync cancelled.";
            }
        }

        function findAndCall(nameQuery) {
            // Fuzzy search
            const match = savedContacts.find(c => c.name.toLowerCase().includes(nameQuery));
            
            if (match) {
                speak(`Calling ${match.name}`);
                setTimeout(() => {
                    window.location.href = `tel:${match.phone}`;
                }, 1000);
            } else {
                speak(`I couldn't find ${nameQuery} in your synced contacts.`);
            }
        }

        function findAndMessage(nameQuery, msg) {
            const match = savedContacts.find(c => c.name.toLowerCase().includes(nameQuery));
            if (match) {
                speak(`Opening WhatsApp for ${match.name}`);
                // Remove spaces/symbols from phone for API
                let cleanPhone = match.phone.replace(/\D/g,'');
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            } else {
                speak(`Contact ${nameQuery} not found.`);
            }
        }

        async function checkBattery() {
            if ('getBattery' in navigator) {
                const battery = await navigator.getBattery();
                const level = Math.round(battery.level * 100);
                speak(`Your battery is at ${level} percent.`);
            } else {
                speak("Battery status not available.");
            }
        }

        // --- 5. PWA INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'inline-block';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installBtn').style.display = 'none';
            }
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
