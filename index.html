<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALTECH AI Assistant - Advanced</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- MODERN THEME VARIABLES --- */
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --primary-light: rgba(0, 123, 255, 0.1);
            --secondary: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --surface: #ffffff;
            --background: #f4f7f9;
            --text: #2c3e50;
            --text-secondary: #6c757d;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
            --radius: 16px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --accent: #6200ea;
            --accent-light: rgba(98, 0, 234, 0.1);
        }

        body.dark-mode {
            --primary: #6200ea;
            --primary-dark: #3700b3;
            --primary-light: rgba(98, 0, 234, 0.1);
            --secondary: #9e9e9e;
            --surface: #1e1e1e;
            --background: #121212;
            --text: #e0e0e0;
            --text-secondary: #b0b0b0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.4);
            --accent: #bb86fc;
            --accent-light: rgba(187, 134, 252, 0.1);
        }

        /* --- BASE STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI', Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            transition: var(--transition);
        }

        /* --- APP CONTAINER --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* --- IMPROVED HEADER --- */
        .header {
            padding: 18px 25px;
            background: var(--surface);
            box-shadow: var(--shadow);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-title i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            background: var(--primary-light);
            color: var(--primary);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .control-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .control-btn.active {
            background: var(--success);
            color: white;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 25px;
            padding: 25px;
        }

        /* --- ENHANCED SIDEBAR --- */
        .sidebar {
            width: 320px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .sidebar-section {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* --- ADVANCED VOICE INTERFACE --- */
        .voice-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--background) 0%, var(--primary-light) 100%);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            border: 2px dashed var(--primary-light);
        }

        .voice-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%);
            opacity: 0.3;
        }

        .voice-orb {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 25px 50px rgba(0, 123, 255, 0.4);
            transition: var(--transition);
            margin-bottom: 35px;
            position: relative;
            z-index: 1;
            border: 6px solid rgba(255, 255, 255, 0.3);
        }

        .voice-orb::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: conic-gradient(transparent, var(--primary), var(--accent), transparent 30%);
            animation: rotate 3s linear infinite;
            border-radius: 50%;
            z-index: -1;
            opacity: 0.8;
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        .voice-orb.listening {
            animation: pulse 1.2s infinite alternate;
            box-shadow: 0 0 80px rgba(0, 123, 255, 0.8);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .voice-orb i {
            font-size: 3.5rem;
            color: white;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }

        .voice-status {
            text-align: center;
            margin-bottom: 35px;
            position: relative;
            z-index: 1;
            width: 100%;
        }

        #status {
            font-size: 1.1rem;
            color: var(--secondary);
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #transcript {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            min-height: 60px;
            padding: 20px 30px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin: 20px auto;
            max-width: 800px;
            width: 100%;
            border-left: 6px solid var(--primary);
            line-height: 1.8;
            backdrop-filter: blur(10px);
        }

        /* --- ENHANCED AI RESPONSE AREA --- */
        .ai-response {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin: 25px auto;
            max-width: 800px;
            width: 100%;
            border-left: 6px solid var(--accent);
            position: relative;
            z-index: 1;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .ai-response h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        #aiOutput {
            font-size: 1.15rem;
            line-height: 1.8;
            min-height: 100px;
            display: flex;
            align-items: center;
        }

        .ai-response-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-response-item {
            padding: 15px;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        /* --- ENHANCED QUICK ACTIONS --- */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin: 25px auto;
            max-width: 850px;
            width: 100%;
        }

        .action-btn {
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.3);
            border-color: transparent;
        }

        .action-btn:hover::before {
            opacity: 0.1;
        }

        .action-btn i {
            font-size: 1.8rem;
            position: relative;
            z-index: 1;
        }

        .action-btn span {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        /* --- ENHANCED TABS --- */
        .tabs-nav {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-bottom: 4px solid transparent;
            letter-spacing: 0.5px;
        }

        .tab-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            background: var(--primary-light);
            border-bottom-color: var(--primary);
            box-shadow: inset 0 -2px 0 var(--primary);
        }

        /* --- TAB CONTENT --- */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 15px;
        }

        .tab-content::-webkit-scrollbar {
            width: 8px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 4px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
            padding: 5px;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ENHANCED CARDS --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 25px;
            transition: var(--transition);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg), 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* --- ENHANCED CONTACTS LIST --- */
        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-light), transparent);
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .contact-item:hover {
            background: linear-gradient(135deg, var(--primary), transparent);
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
        }

        .contact-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.4rem;
            margin-right: 20px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.2rem;
            color: var(--text);
        }

        .contact-phone {
            font-size: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-actions {
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: var(--transition);
        }

        .contact-item:hover .contact-actions {
            opacity: 1;
        }

        /* --- ENHANCED REMINDERS --- */
        .reminders-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .reminder-item {
            background: linear-gradient(135deg, var(--warning), transparent);
            border-radius: var(--radius);
            padding: 20px;
            border-left: 6px solid var(--warning);
            position: relative;
            overflow: hidden;
        }

        .reminder-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning), transparent);
        }

        .reminder-item.due {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), transparent);
        }

        .reminder-item.due::before {
            background: linear-gradient(90deg, var(--danger), transparent);
        }

        .reminder-text {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .reminder-time {
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- ENHANCED NOTES --- */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .note-item {
            background: linear-gradient(135deg, var(--info), transparent);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
            border: 2px solid var(--info);
            transition: var(--transition);
        }

        .note-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(23, 162, 184, 0.2);
        }

        .note-content {
            margin-bottom: 15px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .note-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #quickNotes {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            background: var(--surface);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: var(--transition);
        }

        #quickNotes:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* --- ENHANCED AI PROVIDER SELECTOR --- */
        .ai-provider-selector {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid var(--primary-light);
        }

        .provider-select {
            width: 100%;
            padding: 15px;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            background: var(--background);
            color: var(--text);
            font-size: 1rem;
            margin-top: 15px;
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23007bff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .provider-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* --- ENHANCED COMMAND SUGGESTIONS --- */
        .command-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 25px;
            justify-content: center;
        }

        .command-chip {
            background: linear-gradient(135deg, var(--primary-light), transparent);
            color: var(--primary);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .command-chip:hover {
            background: linear-gradient(135deg, var(--primary), transparent);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }

        /* --- ENHANCED WHATSAPP FLOATING BUTTON --- */
        .whatsapp-float {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 35px rgba(37, 211, 102, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
            font-size: 2rem;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        .whatsapp-float:hover {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 20px 40px rgba(37, 211, 102, 0.6);
        }

        /* --- MODAL ENHANCEMENTS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 35px;
            z-index: 2001;
            display: none;
            animation: modalSlideIn 0.3s ease;
            min-width: 400px;
            max-width: 90vw;
            border: 2px solid var(--primary);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            transform: rotate(90deg);
            background: var(--danger-dark);
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--radius-sm);
            border: 2px solid var(--primary);
            background: var(--background);
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn.primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .modal-btn.secondary {
            background: var(--secondary);
            color: white;
        }

        .modal-btn.secondary:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
        }

        /* --- ENHANCED LOADING ANIMATIONS --- */
        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0,123,255,0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 15px;
            background: var(--primary-light);
            border-radius: var(--radius);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        /* --- PROGRESS INDICATORS --- */
        .progress-bar {
            height: 6px;
            background: var(--primary-light);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* --- STATUS INDICATORS --- */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-online {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .status-offline {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        /* --- ENHANCED RESPONSIVE DESIGN --- */
        @media (max-width: 1200px) {
            .main-content {
                gap: 20px;
                padding: 20px;
            }
            
            .sidebar {
                width: 280px;
            }
            
            .notes-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .app-title {
                font-size: 1.4rem;
            }
            
            .voice-orb {
                width: 140px;
                height: 140px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .main-content {
                flex-direction: column;
                padding: 15px;
            }
            
            .voice-orb {
                width: 120px;
                height: 120px;
            }
            
            .voice-orb i {
                font-size: 3rem;
            }
            
            #transcript {
                font-size: 1.2rem;
                padding: 15px 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .command-suggestions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .command-chip {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .whatsapp-float {
                bottom: 25px;
                right: 25px;
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .modal {
                min-width: 90%;
                padding: 25px;
            }
            
            .tabs-nav {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1 0 calc(33.333% - 10px);
                padding: 15px 10px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 576px) {
            .app-title {
                font-size: 1.3rem;
            }
            
            .voice-orb {
                width: 100px;
                height: 100px;
            }
            
            .voice-orb i {
                font-size: 2.5rem;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .action-btn {
                padding: 15px;
            }
            
            .action-btn i {
                font-size: 1.5rem;
            }
            
            .tab-btn {
                flex: 1 0 calc(50% - 10px);
                font-size: 0.85rem;
                padding: 12px 8px;
            }
            
            .card {
                padding: 20px;
            }
            
            .modal {
                padding: 20px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }

        /* --- UTILITY CLASSES --- */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-20 {
            padding: 20px;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .pulse-success {
            animation: pulseSuccess 2s infinite;
        }

        @keyframes pulseSuccess {
            0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .glow {
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 10px var(--primary); }
            to { box-shadow: 0 0 25px var(--primary); }
        }

        /* --- NOTIFICATION TOAST --- */
        .toast {
            position: fixed;
            bottom: 100px;
            right: 40px;
            background: var(--surface);
            color: var(--text);
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            display: none;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--success);
            max-width: 350px;
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* --- CONTEXT MENU --- */
        .context-menu {
            position: absolute;
            background: var(--surface);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 10px 0;
            z-index: 1000;
            min-width: 200px;
            display: none;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: var(--primary-light);
        }

        /* --- SEARCH BAR --- */
        .search-bar {
            position: relative;
            margin: 20px 0;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            background: var(--surface);
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            pointer-events: none;
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Notification Toast -->
    <div class="toast" id="notificationToast"></div>

    <!-- WhatsApp Floating Button -->
    <div class="whatsapp-float" onclick="toggleWhatsAppModal()">
        <i class="fab fa-whatsapp"></i>
    </div>
    
    <!-- WhatsApp Modal -->
    <div class="modal-overlay" id="whatsappModalOverlay" onclick="closeAllModals()"></div>
    <div class="modal" id="whatsappModal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fab fa-whatsapp"></i> Get Help</h3>
            <button class="modal-close" onclick="closeWhatsAppModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p style="margin: 15px 0; color: var(--text-secondary);">Need assistance with the AI Assistant?</p>
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="openWhatsApp('help')">
                <i class="fas fa-question-circle"></i> Technical Support
            </button>
            <button class="modal-btn primary" onclick="openWhatsApp('feedback')">
                <i class="fas fa-comment-alt"></i> Send Feedback
            </button>
            <button class="modal-btn primary" onclick="openWhatsApp('feature')">
                <i class="fas fa-lightbulb"></i> Request Feature
            </button>
            <button class="modal-btn primary" onclick="openWhatsApp('demo')" style="background: var(--success);">
                <i class="fas fa-phone-alt"></i> Schedule Demo Call
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="app-title">
                    <i class="fas fa-robot"></i>
                    <span>ALTECH AI Assistant v3.0</span>
                    <span class="status-indicator status-online" id="connectionStatus">
                        <i class="fas fa-wifi"></i> Online
                    </span>
                </div>
                
                <div class="header-controls">
                    <button class="control-btn active" id="aiToggleBtn" onclick="toggleAIMode()" title="Toggle AI Mode">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="control-btn" onclick="toggleTheme()" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="control-btn" onclick="showSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="control-btn" onclick="exportData()" title="Export Data">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="ai-provider-selector">
                    <h3><i class="fas fa-cogs"></i> AI Settings</h3>
                    <select id="aiProvider" class="provider-select" onchange="changeAIProvider(this.value)">
                        <option value="smart">ðŸ¤– Smart Mode (Auto)</option>
                        <option value="chatgpt">ðŸ’¬ ChatGPT 4</option>
                        <option value="llama">ðŸ¦™ Llama 3</option>
                        <option value="gemini">ðŸ”· Gemini Pro</option>
                        <option value="claude">ðŸŽ¯ Claude 3</option>
                        <option value="local">ðŸ’¡ Local Only</option>
                    </select>
                    <div id="aiStatus" style="margin-top: 15px; font-size: 0.95rem;">
                        <span class="status-indicator status-online">
                            <i class="fas fa-check-circle"></i> AI Ready
                        </span>
                    </div>
                    <div class="progress-bar mt-20">
                        <div class="progress-fill" id="aiHealth" style="width: 100%"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> Recent Commands</h2>
                        <button class="control-btn" onclick="clearHistory()" title="Clear History">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="commandHistory">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            No commands yet. Start by saying something!
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Quick Stats</h2>
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-users"></i> Contacts:</span>
                            <span id="contactCount" class="status-indicator">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-bell"></i> Reminders:</span>
                            <span id="reminderCount" class="status-indicator">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-sticky-note"></i> Notes:</span>
                            <span id="noteCount" class="status-indicator">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-brain"></i> AI Responses:</span>
                            <span id="aiResponseCount" class="status-indicator">0</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-bolt"></i> Quick Access</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                        <button class="action-btn" onclick="quickAction('time')">
                            <i class="fas fa-clock"></i>
                            <span>Time</span>
                        </button>
                        <button class="action-btn" onclick="quickAction('weather')">
                            <i class="fas fa-cloud-sun"></i>
                            <span>Weather</span>
                        </button>
                        <button class="action-btn" onclick="quickAction('joke')">
                            <i class="fas fa-laugh"></i>
                            <span>Joke</span>
                        </button>
                        <button class="action-btn" onclick="quickAction('quote')">
                            <i class="fas fa-quote-right"></i>
                            <span>Quote</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- MAIN AREA -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <!-- TABS -->
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="openTab('assistant')">
                        <i class="fas fa-robot"></i> Assistant
                    </button>
                    <button class="tab-btn" onclick="openTab('contacts')">
                        <i class="fas fa-address-book"></i> Contacts
                    </button>
                    <button class="tab-btn" onclick="openTab('reminders')">
                        <i class="fas fa-bell"></i> Reminders
                    </button>
                    <button class="tab-btn" onclick="openTab('notes')">
                        <i class="fas fa-sticky-note"></i> Notes
                    </button>
                    <button class="tab-btn" onclick="openTab('search')">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="tab-btn" onclick="openTab('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>

                <!-- TAB CONTENT -->
                <div class="tab-content">
                    <!-- ASSISTANT TAB -->
                    <div id="assistant" class="tab-pane active">
                        <div class="voice-section">
                            <div class="voice-orb" onclick="toggleListening()" id="voiceOrb">
                                <i class="fas fa-microphone"></i>
                            </div>
                            
                            <div class="voice-status">
                                <div id="status">Ready to listen. Tap the orb or say "Hey ALTECH"</div>
                                <div id="transcript">Say something like: "Add note meeting at 3 PM" or "Call John"</div>
                            </div>

                            <div class="ai-response">
                                <h3><i class="fas fa-brain"></i> AI Assistant Response</h3>
                                <div id="aiOutput">
                                    <div class="typing-indicator">
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                    </div>
                                    Initializing AI Assistant...
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="quick-actions">
                                <button class="action-btn" onclick="quickAction('call_last')">
                                    <i class="fas fa-phone"></i>
                                    <span>Call Last</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('add_note')">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>Quick Note</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('weather')">
                                    <i class="fas fa-cloud-sun"></i>
                                    <span>Weather</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('search')">
                                    <i class="fas fa-search"></i>
                                    <span>Web Search</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('joke')">
                                    <i class="fas fa-laugh"></i>
                                    <span>Tell Joke</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('time')">
                                    <i class="fas fa-clock"></i>
                                    <span>What Time?</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('message')">
                                    <i class="fas fa-sms"></i>
                                    <span>Send SMS</span>
                                </button>
                                <button class="action-btn" onclick="quickAction('email')">
                                    <i class="fas fa-envelope"></i>
                                    <span>Send Email</span>
                                </button>
                            </div>

                            <!-- Command Suggestions -->
                            <div class="command-suggestions">
                                <div class="command-chip" onclick="speakCommand('Add note meeting at 3 PM tomorrow')">
                                    <i class="fas fa-edit"></i> Add Note
                                </div>
                                <div class="command-chip" onclick="speakCommand('Remind me to call mom tomorrow at 10 AM')">
                                    <i class="fas fa-bell"></i> Set Reminder
                                </div>
                                <div class="command-chip" onclick="speakCommand('Search for latest technology news')">
                                    <i class="fas fa-search"></i> Search Web
                                </div>
                                <div class="command-chip" onclick="speakCommand('What time is it in London?')">
                                    <i class="fas fa-clock"></i> World Time
                                </div>
                                <div class="command-chip" onclick="speakCommand('Send WhatsApp to John saying hello')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </div>
                                <div class="command-chip" onclick="speakCommand('Weather in New York')">
                                    <i class="fas fa-cloud-sun-rain"></i> Weather
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTACTS TAB -->
                    <div id="contacts" class="tab-pane">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-users"></i> Contact Management</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="control-btn" onclick="trySyncContacts()" title="Sync Contacts">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    <button class="control-btn" onclick="showAddContactModal()" title="Add Contact">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="search-bar">
                                <input type="text" class="search-input" id="contactSearch" 
                                       placeholder="Search contacts..." oninput="searchContacts(this.value)">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            
                            <div id="contactsList" class="contacts-list">
                                <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                    No contacts yet. Add your first contact!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- REMINDERS TAB -->
                    <div id="reminders" class="tab-pane">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-clock"></i> Active Reminders</h2>
                                <button class="control-btn" onclick="showAddReminderModal()" title="Add Reminder">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <div id="remindersList" class="reminders-list">
                                <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                    No reminders scheduled. Add your first reminder!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- NOTES TAB -->
                    <div id="notes" class="tab-pane">
                        <div class="card">
                            <h2><i class="fas fa-edit"></i> Quick Notes</h2>
                            <textarea id="quickNotes" rows="12" 
                                      placeholder="Type your notes here or use voice commands like 'Add note meeting tomorrow'... Your notes are automatically saved locally."></textarea>
                            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="action-btn" onclick="saveNotes()">
                                    <i class="fas fa-save"></i> Save Notes
                                </button>
                                <button class="action-btn" onclick="clearNotes()" style="background: var(--danger);">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                                <button class="action-btn" onclick="exportNotes()" style="background: var(--success);">
                                    <i class="fas fa-download"></i> Export Notes
                                </button>
                                <button class="action-btn" onclick="speakCommand('Add note ' + document.getElementById('quickNotes').value.substring(0, 50))">
                                    <i class="fas fa-microphone"></i> Voice Note
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-history"></i> Recent Notes</h2>
                                <button class="control-btn" onclick="refreshNotes()" title="Refresh">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                            <div id="notesHistory" class="notes-container">
                                <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                    No recent notes. Start by adding a note!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- SEARCH TAB -->
                    <div id="search" class="tab-pane">
                        <div class="card">
                            <h2><i class="fas fa-search"></i> Smart Search</h2>
                            <div class="search-bar">
                                <input type="text" class="search-input" id="webSearch" 
                                       placeholder="Search the web, your notes, contacts, or ask anything..."
                                       onkeypress="if(event.key === 'Enter') performSearch()">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="action-btn" onclick="performSearch()">
                                    <i class="fas fa-search"></i> Web Search
                                </button>
                                <button class="action-btn" onclick="searchWikipedia()">
                                    <i class="fab fa-wikipedia-w"></i> Wikipedia
                                </button>
                                <button class="action-btn" onclick="searchNews()">
                                    <i class="fas fa-newspaper"></i> News
                                </button>
                                <button class="action-btn" onclick="searchImages()">
                                    <i class="fas fa-image"></i> Images
                                </button>
                                <button class="action-btn" onclick="searchVideos()">
                                    <i class="fas fa-video"></i> Videos
                                </button>
                            </div>
                            
                            <div id="searchResults" style="margin-top: 30px;">
                                <h3 style="margin-bottom: 20px; color: var(--primary);">
                                    <i class="fas fa-list"></i> Search Results
                                </h3>
                                <div id="resultsContainer" style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                    Enter a search term above to see results here
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS TAB -->
                    <div id="settings" class="tab-pane">
                        <div class="card">
                            <h2><i class="fas fa-user-cog"></i> Preferences & Settings</h2>
                            <div style="margin-top: 25px;">
                                <div style="margin-bottom: 25px;">
                                    <h3 style="font-size: 1.2rem; margin-bottom: 15px; color: var(--primary);">
                                        <i class="fas fa-volume-up"></i> Voice Settings
                                    </h3>
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Voice Speed</label>
                                        <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1" 
                                               oninput="updateVoiceSpeed(this.value)" style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                            <span>Slow</span>
                                            <span id="speedValue">Normal</span>
                                            <span>Fast</span>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="voiceFeedback" checked>
                                            <span>Enable voice feedback</span>
                                        </label>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="wakeWord" checked>
                                            <span>Enable "Hey ALTECH" wake word</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h3 style="font-size: 1.2rem; margin-bottom: 15px; color: var(--primary);">
                                        <i class="fas fa-bell"></i> Notifications
                                    </h3>
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="enableNotifications" checked>
                                            <span>Enable notifications</span>
                                        </label>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="autoSave" checked>
                                            <span>Auto-save notes</span>
                                        </label>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="darkModeAuto" checked>
                                            <span>Auto dark mode (sunset to sunrise)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h3 style="font-size: 1.2rem; margin-bottom: 15px; color: var(--primary);">
                                        <i class="fas fa-shield-alt"></i> Privacy & Security
                                    </h3>
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="localStorage" checked>
                                            <span>Store data locally only</span>
                                        </label>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                            <input type="checkbox" id="clearOnExit" checked>
                                            <span>Clear sensitive data on exit</span>
                                        </label>
                                    </div>
                                    
                                    <button class="action-btn" onclick="clearBrowserCache()" style="width: 100%; margin-top: 10px;">
                                        <i class="fas fa-broom"></i> Clear Browser Cache
                                    </button>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px;">
                                    <button class="action-btn" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export All Data
                                    </button>
                                    <button class="action-btn" onclick="importData()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                    <button class="action-btn" onclick="resetSettings()" style="background: var(--warning);">
                                        <i class="fas fa-redo"></i> Reset Settings
                                    </button>
                                    <button class="action-btn" onclick="clearAllData()" style="background: var(--danger);">
                                        <i class="fas fa-trash-alt"></i> Clear All Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h2><i class="fas fa-info-circle"></i> About & Information</h2>
                            <div style="margin-top: 20px;">
                                <p style="margin-bottom: 15px;"><strong style="font-size: 1.2rem;">ALTECH AI Assistant v3.0</strong></p>
                                <p>Advanced AI Assistant with Natural Language Understanding</p>
                                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, var(--primary-light), transparent); border-radius: var(--radius);">
                                    <p style="font-size: 0.95rem; color: var(--text); margin-bottom: 10px;">
                                        <i class="fas fa-shield-alt"></i> <strong>Privacy First:</strong> All data is stored locally on your device. No personal information is shared without your permission.
                                    </p>
                                    <p style="font-size: 0.95rem; color: var(--text); margin-bottom: 10px;">
                                        <i class="fas fa-bolt"></i> <strong>Features:</strong> Voice recognition, Contact management, Reminders, Notes, Web search, Calls, Messages, Weather, Time, and more!
                                    </p>
                                    <p style="font-size: 0.95rem; color: var(--text);">
                                        <i class="fas fa-code"></i> <strong>Technology:</strong> Built with modern web technologies and AI integration
                                    </p>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                                    <button class="action-btn" onclick="showTutorial()">
                                        <i class="fas fa-graduation-cap"></i> Tutorial
                                    </button>
                                    <button class="action-btn" onclick="checkForUpdates()">
                                        <i class="fas fa-sync"></i> Check Updates
                                    </button>
                                    <button class="action-btn" onclick="showPrivacyPolicy()">
                                        <i class="fas fa-file-contract"></i> Privacy Policy
                                    </button>
                                    <button class="action-btn" onclick="showTerms()">
                                        <i class="fas fa-balance-scale"></i> Terms
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="addContactModalOverlay" onclick="closeAllModals()"></div>
    <div class="modal" id="addContactModal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Add Contact</h3>
            <button class="modal-close" onclick="closeModal('addContactModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" class="modal-input" id="newContactName" placeholder="Contact Name" autocomplete="name">
        <input type="tel" class="modal-input" id="newContactPhone" placeholder="Phone Number (e.g., 0712345678)" autocomplete="tel">
        <input type="email" class="modal-input" id="newContactEmail" placeholder="Email Address (optional)" autocomplete="email">
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="addNewContact()">
                <i class="fas fa-save"></i> Save Contact
            </button>
            <button class="modal-btn secondary" onclick="closeModal('addContactModal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="addReminderModalOverlay" onclick="closeAllModals()"></div>
    <div class="modal" id="addReminderModal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-bell"></i> Add Reminder</h3>
            <button class="modal-close" onclick="closeModal('addReminderModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" class="modal-input" id="newReminderText" placeholder="What to remind?">
        <input type="datetime-local" class="modal-input" id="newReminderTime">
        <select class="modal-input" id="reminderPriority">
            <option value="low">Low Priority</option>
            <option value="medium" selected>Medium Priority</option>
            <option value="high">High Priority</option>
        </select>
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="addNewReminder()">
                <i class="fas fa-save"></i> Save Reminder
            </button>
            <button class="modal-btn secondary" onclick="closeModal('addReminderModal')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModalOverlay" onclick="closeAllModals()"></div>
    <div class="modal" id="settingsModal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-cog"></i> Advanced Settings</h3>
            <button class="modal-close" onclick="closeModal('settingsModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Settings content would go here -->
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save Settings
            </button>
            <button class="modal-btn secondary" onclick="closeModal('settingsModal')">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="callSelectedContact()">
            <i class="fas fa-phone"></i> Call
        </div>
        <div class="context-menu-item" onclick="messageSelectedContact()">
            <i class="fas fa-sms"></i> Send SMS
        </div>
        <div class="context-menu-item" onclick="whatsappSelectedContact()">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </div>
        <div class="context-menu-item" onclick="emailSelectedContact()">
            <i class="fas fa-envelope"></i> Email
        </div>
        <div class="context-menu-item" onclick="editSelectedContact()">
            <i class="fas fa-edit"></i> Edit
        </div>
        <div class="context-menu-item" onclick="deleteSelectedContact()" style="color: var(--danger);">
            <i class="fas fa-trash"></i> Delete
        </div>
    </div>

    <script>
        // ================ ADVANCED CORE VARIABLES ================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = false;
        recognition.maxAlternatives = 3;

        // Speech Synthesis
        const synth = window.speechSynthesis;
        let voices = [];

        // DOM Elements
        const voiceOrb = document.querySelector('.voice-orb');
        const statusEl = document.getElementById('status');
        const transcriptEl = document.getElementById('transcript');
        const aiOutputEl = document.getElementById('aiOutput');
        const quickNotesEl = document.getElementById('quickNotes');
        const aiToggleBtn = document.getElementById('aiToggleBtn');
        const aiProviderSelect = document.getElementById('aiProvider');
        const aiStatusEl = document.getElementById('aiStatus');
        const connectionStatusEl = document.getElementById('connectionStatus');

        // Advanced Data Storage
        let myContacts = JSON.parse(localStorage.getItem('altech_contacts') || '[]');
        let reminders = JSON.parse(localStorage.getItem('altech_reminders') || '[]');
        let conversationHistory = JSON.parse(localStorage.getItem('altech_history') || '[]');
        let notesHistory = JSON.parse(localStorage.getItem('altech_notes_history') || '[]');
        let settings = JSON.parse(localStorage.getItem('altech_settings') || '{}');
        let isListening = false;
        let aiEnabled = true;
        let currentAIProvider = 'smart';
        let voiceSpeed = parseFloat(localStorage.getItem('voiceSpeed') || '1');
        let aiResponseCount = parseInt(localStorage.getItem('aiResponseCount') || '0');
        let wakeWordEnabled = true;
        let wakeWordDetected = false;
        let selectedContact = null;
        let contextMenuVisible = false;

        // Advanced Conversation Context
        let conversationContext = {
            lastTopic: '',
            lastContact: null,
            lastAction: '',
            userPreferences: JSON.parse(localStorage.getItem('user_prefs') || '{}'),
            sessionId: Date.now(),
            conversationFlow: [],
            emotion: 'neutral'
        };

        // AI Endpoints Configuration
        const AI_ENDPOINTS = {
            smart: { name: 'Smart Mode', priority: ['chatgpt', 'gemini', 'llama', 'claude'] },
            chatgpt: { 
                name: 'ChatGPT 4',
                endpoints: [
                    'https://chatgpt-api.shn.hk/v1/',
                    'https://free.churchless.tech/v1/chat/completions',
                    'https://api.openai-proxy.org/v1/chat/completions'
                ]
            },
            llama: {
                name: 'Llama 3',
                endpoints: [
                    'https://api.llama-api.com/chat/completions'
                ]
            },
            gemini: {
                name: 'Gemini Pro',
                endpoints: [
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
                ]
            },
            claude: {
                name: 'Claude 3',
                endpoints: [
                    'https://api.anthropic.com/v1/messages'
                ]
            }
        };

        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', () => {
            initAdvancedApp();
        });

        async function initAdvancedApp() {
            console.log('ðŸš€ Initializing ALTECH AI Assistant v3.0...');
            
            // Load all settings and data
            await Promise.all([
                loadTheme(),
                loadSettings(),
                loadNotes(),
                loadStats(),
                loadVoices()
            ]);
            
            // Initialize components
            renderContacts();
            renderReminders();
            renderNotesHistory();
            renderCommandHistory();
            setupAdvancedVoiceRecognition();
            updateVoiceSpeed(voiceSpeed);
            checkAndSetReminderInterval();
            setupAutoSave();
            setupWakeWordDetection();
            checkInternetConnection();
            setupServiceWorker();
            
            // Show welcome message
            setTimeout(() => {
                showNotification('ALTECH AI Assistant v3.0 is ready!', 'success');
                speakResponse("Welcome to ALTECH AI Assistant version 3.0. I'm ready to help you!");
                updateAIResponse(`
                    <div class="ai-response-content">
                        <div class="ai-response-item">
                            <strong>ðŸ¤– ALTECH AI Assistant v3.0</strong>
                            <p>I'm your advanced AI assistant with natural language understanding.</p>
                        </div>
                        <div class="ai-response-item">
                            <strong>ðŸŽ¯ What I can do:</strong>
                            <ul>
                                <li>ðŸ“ž Make calls and send messages</li>
                                <li>ðŸ“ Add notes and reminders</li>
                                <li>ðŸŒ¤ï¸ Check weather and time</li>
                                <li>ðŸ” Search the web intelligently</li>
                                <li>ðŸ’¬ Understand natural language</li>
                                <li>âš¡ Quick actions and automation</li>
                            </ul>
                        </div>
                        <div class="ai-response-item">
                            <strong>ðŸ’¡ Try saying:</strong>
                            <p>"Add note meeting tomorrow at 3 PM"</p>
                            <p>"Remind me to call mom tomorrow"</p>
                            <p>"Search for latest AI news"</p>
                            <p>"What time is it in London?"</p>
                        </div>
                    </div>
                `);
            }, 1500);
            
            // Setup periodic tasks
            setInterval(checkReminders, 60000); // Check every minute
            setInterval(updateConnectionStatus, 30000); // Update connection status every 30 seconds
            setInterval(autoBackup, 3600000); // Auto backup every hour
            
            console.log('âœ… ALTECH AI Assistant initialized successfully');
        }

        // ================ THEME MANAGEMENT ================
        async function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark-mode';
            document.body.className = savedTheme;
            updateThemeIcon(savedTheme);
            
            // Auto dark mode based on time
            if (settings.darkModeAuto) {
                const hour = new Date().getHours();
                const isNight = hour < 6 || hour > 18;
                if (isNight && savedTheme !== 'dark-mode') {
                    toggleTheme();
                }
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.className;
            const newTheme = currentTheme === 'dark-mode' ? 'light-mode' : 'dark-mode';
            document.body.className = newTheme;
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            showNotification(`Switched to ${newTheme} mode`, 'info');
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-toggle i') || document.querySelector('[onclick="toggleTheme()"] i');
            if (icon) {
                icon.className = theme === 'dark-mode' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        // ================ ADVANCED VOICE RECOGNITION ================
        function setupAdvancedVoiceRecognition() {
            recognition.onstart = () => {
                isListening = true;
                voiceOrb.classList.add('listening');
                statusEl.textContent = 'ðŸŽ¤ Listening... Speak now';
                updateAIResponse('<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div> Listening...');
                showNotification('Listening...', 'info');
            };

            recognition.onend = () => {
                isListening = false;
                voiceOrb.classList.remove('listening');
                statusEl.textContent = 'âœ… Ready';
                wakeWordDetected = false;
            };

            recognition.onresult = async (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update transcript in real-time
                if (interimTranscript) {
                    transcriptEl.textContent = interimTranscript;
                }
                
                if (finalTranscript) {
                    transcriptEl.textContent = finalTranscript;
                    
                    // Check for wake word
                    if (wakeWordEnabled && !wakeWordDetected) {
                        if (finalTranscript.toLowerCase().includes('hey altech') || 
                            finalTranscript.toLowerCase().includes('hello altech')) {
                            wakeWordDetected = true;
                            speakResponse("Yes, I'm listening. How can I help you?");
                            updateAIResponse("Yes, I'm listening. How can I help you?");
                            return;
                        }
                    }
                    
                    if (wakeWordDetected || !wakeWordEnabled) {
                        await handleAdvancedCommand(finalTranscript);
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                updateAIResponse(`Error: ${event.error}. Please check microphone permissions.`);
                showNotification('Microphone error. Please check permissions.', 'error');
                voiceOrb.classList.remove('listening');
                isListening = false;
            };
        }

        function toggleListening() {
            if (isListening) {
                recognition.stop();
                voiceOrb.classList.remove('listening');
                statusEl.textContent = 'â¹ï¸ Stopped';
                showNotification('Stopped listening', 'info');
                isListening = false;
            } else {
                try {
                    recognition.start();
                    showNotification('Started listening', 'success');
                } catch (error) {
                    console.error('Speech recognition error:', error);
                    updateAIResponse('Speech recognition not available. Please check microphone permissions.');
                    showNotification('Cannot access microphone', 'error');
                }
            }
        }

        function setupWakeWordDetection() {
            if (wakeWordEnabled && 'webkitSpeechRecognition' in window) {
                const wakeWordRecognition = new webkitSpeechRecognition();
                wakeWordRecognition.continuous = true;
                wakeWordRecognition.interimResults = false;
                wakeWordRecognition.lang = 'en-US';
                
                wakeWordRecognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                    if (transcript.includes('hey altech') || transcript.includes('hello altech')) {
                        wakeWordDetected = true;
                        speakResponse("Yes, I'm here!");
                        updateAIResponse("Yes, I'm here! How can I help you?");
                        recognition.start();
                    }
                };
                
                wakeWordRecognition.start();
            }
        }

        // ================ ADVANCED AI INTEGRATION ================
        async function getAdvancedAIResponse(userMessage) {
            if (!aiEnabled) {
                return "AI is currently disabled. Enable it in settings to get intelligent responses.";
            }

            aiResponseCount++;
            localStorage.setItem('aiResponseCount', aiResponseCount.toString());
            updateStats();

            try {
                let response;
                const startTime = Date.now();
                
                switch(currentAIProvider) {
                    case 'smart':
                        response = await smartAIResponse(userMessage);
                        break;
                    case 'chatgpt':
                        response = await chatGPTResponse(userMessage);
                        break;
                    case 'llama':
                        response = await llamaResponse(userMessage);
                        break;
                    case 'gemini':
                        response = await geminiResponse(userMessage);
                        break;
                    case 'claude':
                        response = await claudeResponse(userMessage);
                        break;
                    default:
                        response = await localAIResponse(userMessage);
                }
                
                const responseTime = Date.now() - startTime;
                console.log(`AI Response time: ${responseTime}ms`);
                
                // Update AI health indicator
                updateAIHealthIndicator(responseTime);
                
                return response || "I'm having trouble connecting to the AI service. Please try again or switch to a different AI provider.";
            } catch (error) {
                console.error('AI Error:', error);
                return await localAIResponse(userMessage);
            }
        }

        // Enhanced Smart AI with fallback
        async function smartAIResponse(prompt) {
            const providers = AI_ENDPOINTS.smart.priority;
            
            for (const provider of providers) {
                try {
                    let response;
                    switch(provider) {
                        case 'chatgpt':
                            response = await chatGPTResponse(prompt);
                            break;
                        case 'gemini':
                            response = await geminiResponse(prompt);
                            break;
                        case 'llama':
                            response = await llamaResponse(prompt);
                            break;
                        case 'claude':
                            response = await claudeResponse(prompt);
                            break;
                    }
                    
                    if (response && response.length > 10) {
                        console.log(`âœ… Using ${provider} response`);
                        return response;
                    }
                } catch (error) {
                    console.log(`âŒ ${provider} failed, trying next...`);
                    continue;
                }
            }
            
            return localAIResponse(prompt);
        }

        // Enhanced ChatGPT with multiple endpoints
        async function chatGPTResponse(prompt) {
            const endpoints = AI_ENDPOINTS.chatgpt.endpoints;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [{ 
                                role: "user", 
                                content: prompt,
                                context: conversationContext 
                            }],
                            max_tokens: 500,
                            temperature: 0.7
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content;
                    }
                } catch (error) {
                    continue;
                }
            }
            
            return null;
        }

        // Enhanced Llama 3
        async function llamaResponse(prompt) {
            try {
                const response = await fetch('https://api.llama-api.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer LL-API-KEY-HERE', // Replace with actual key
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "llama-70b",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.choices[0].message.content;
                }
            } catch (error) {
                console.log('Llama API failed');
            }
            return null;
        }

        // Enhanced Gemini Pro
        async function geminiResponse(prompt) {
            try {
                // Using a proxy for Gemini API
                const response = await fetch('https://gemini-proxy.vercel.app/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        model: "gemini-pro",
                        temperature: 0.7
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.text;
                }
            } catch (error) {
                console.log('Gemini failed');
            }
            return null;
        }

        // Claude 3 Integration
        async function claudeResponse(prompt) {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'YOUR_CLAUDE_API_KEY', // Replace with actual key
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: "claude-3-opus-20240229",
                        max_tokens: 1000,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.content[0].text;
                }
            } catch (error) {
                console.log('Claude API failed');
            }
            return null;
        }

        // Enhanced Local AI with better understanding
        function localAIResponse(command) {
            const lowerCmd = command.toLowerCase();
            const responses = {
                greeting: [
                    "Hello! How can I assist you today?", 
                    "Hi there! I'm your ALTECH AI Assistant. What can I do for you?",
                    "Hey! Ready to help with calls, notes, reminders, searches, and more!"
                ],
                time: [
                    `The current time is ${new Date().toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true 
                    })}`,
                    `It's ${new Date().toLocaleTimeString()} right now`
                ],
                date: [
                    `Today is ${new Date().toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}`
                ],
                weather: [
                    "I can check weather for any location. Try saying 'weather in [city name]' or 'what's the weather like today?'"
                ],
                joke: [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "What do you call a fake noodle? An impasta!",
                    "Why did the scarecrow win an award? He was outstanding in his field!"
                ],
                help: [
                    "I can help you with: ðŸ“ž Making calls, ðŸ’¬ Sending messages, ðŸ“ Taking notes, â° Setting reminders, ðŸŒ¤ï¸ Weather info, ðŸ•’ Time and date, ðŸ” Web searches, ðŸŽµ Playing music, ðŸ“§ Sending emails, and much more!"
                ],
                capabilities: [
                    "I understand natural language! Try: 'Add note meeting tomorrow', 'Call mom', 'Remind me to buy groceries', 'Search for AI news', 'What's the weather?', 'Tell me a joke', 'Send WhatsApp to John'"
                ]
            };
            
            // Pattern matching for better understanding
            if (/(hello|hi|hey|greetings)/i.test(lowerCmd)) {
                return responses.greeting[Math.floor(Math.random() * responses.greeting.length)];
            }
            if (/(time|what.time|current.time)/i.test(lowerCmd)) {
                return responses.time[0];
            }
            if (/(date|what.date|today.date)/i.test(lowerCmd)) {
                return responses.date[0];
            }
            if (/(weather|forecast|temperature)/i.test(lowerCmd)) {
                return responses.weather[0];
            }
            if (/(joke|funny|make.me.laugh)/i.test(lowerCmd)) {
                return responses.joke[Math.floor(Math.random() * responses.joke.length)];
            }
            if (/(help|what.can.you.do|capabilities)/i.test(lowerCmd)) {
                return responses.capabilities[0];
            }
            if (/(thank.you|thanks|appreciate)/i.test(lowerCmd)) {
                return "You're welcome! Is there anything else I can help you with?";
            }
            if (/(goodbye|bye|see.you)/i.test(lowerCmd)) {
                return "Goodbye! Have a great day!";
            }
            
            // Advanced pattern matching
            const patterns = {
                addNote: /(add.note|create.note|note.that|remember.that)/i,
                setReminder: /(remind.me|set.reminder|alert.me)/i,
                makeCall: /(call|phone|dial)/i,
                sendMessage: /(send.message|text|sms|whatsapp)/i,
                searchWeb: /(search|google|find|look.up)/i,
                getWeather: /(weather.in|forecast.for)/i,
                getTime: /(time.in|what.time.in)/i
            };
            
            for (const [action, pattern] of Object.entries(patterns)) {
                if (pattern.test(lowerCmd)) {
                    switch(action) {
                        case 'addNote':
                            return "I'll add a note for you. What would you like the note to say?";
                        case 'setReminder':
                            return "I can set a reminder. What should I remind you about and when?";
                        case 'makeCall':
                            return "I can make a call. Who would you like to call?";
                        case 'sendMessage':
                            return "I can send a message. Who should I message and what should I say?";
                        case 'searchWeb':
                            return "I can search the web. What would you like me to search for?";
                        case 'getWeather':
                            return "I can check the weather. Which city or location?";
                        case 'getTime':
                            return "I can tell you the time. Which timezone or city?";
                    }
                }
            }
            
            return `I understood: "${command}". I can help you with calls, messages, notes, reminders, searches, weather, time, and more! Try being more specific, like "Call John" or "Add note meeting tomorrow at 3 PM".`;
        }

        function changeAIProvider(provider) {
            currentAIProvider = provider;
            localStorage.setItem('aiProvider', provider);
            updateAIStatus();
            updateAIResponse(`âœ… Switched to ${AI_ENDPOINTS[provider]?.name || provider} mode`);
            showNotification(`AI Provider: ${AI_ENDPOINTS[provider]?.name || provider}`, 'success');
        }

        function toggleAIMode() {
            aiEnabled = !aiEnabled;
            aiToggleBtn.classList.toggle('active', aiEnabled);
            aiToggleBtn.innerHTML = `<i class="fas fa-${aiEnabled ? 'brain' : 'ban'}"></i>`;
            localStorage.setItem('aiEnabled', aiEnabled);
            updateAIResponse(`AI ${aiEnabled ? 'âœ… enabled' : 'âŒ disabled'}`);
            showNotification(`AI ${aiEnabled ? 'enabled' : 'disabled'}`, aiEnabled ? 'success' : 'warning');
        }

        function updateAIStatus() {
            if (aiEnabled) {
                aiStatusEl.innerHTML = `
                    <span class="status-indicator status-online">
                        <i class="fas fa-check-circle"></i> ${AI_ENDPOINTS[currentAIProvider]?.name || currentAIProvider.toUpperCase()} Active
                    </span>
                `;
            } else {
                aiStatusEl.innerHTML = `
                    <span class="status-indicator status-offline">
                        <i class="fas fa-times-circle"></i> AI Disabled
                    </span>
                `;
            }
        }

        function updateAIHealthIndicator(responseTime) {
            const healthBar = document.getElementById('aiHealth');
            if (healthBar) {
                let health = 100;
                if (responseTime > 5000) health = 50;
                if (responseTime > 10000) health = 20;
                healthBar.style.width = `${health}%`;
                healthBar.style.background = health > 70 ? 'var(--success)' : 
                                           health > 30 ? 'var(--warning)' : 
                                           'var(--danger)';
            }
        }

        // ================ ADVANCED COMMAND HANDLER ================
        async function handleAdvancedCommand(command) {
            updateAIResponse('<div class="loading"></div> Processing your command...');
            
            // Save to history
            addToHistory(command);
            updateConversationContext(command);
            
            // Check for specific commands first with improved pattern matching
            const specificResult = await handleSpecificCommandAdvanced(command);
            if (specificResult.handled) return;
            
            // If AI is enabled, use it for general queries
            if (aiEnabled) {
                const aiResponse = await getAdvancedAIResponse(command);
                speakResponse(aiResponse);
                updateAIResponse(formatAIResponse(aiResponse, command));
            } else {
                const localResponse = localAIResponse(command);
                speakResponse(localResponse);
                updateAIResponse(formatAIResponse(localResponse, command));
            }
        }

        async function handleSpecificCommandAdvanced(command) {
            const lowerCmd = command.toLowerCase();
            let handled = false;
            let response = '';
            
            // Enhanced contact calling
            if (/(call|phone|dial|ring)/i.test(lowerCmd)) {
                const nameMatch = lowerCmd.match(/(?:call|phone|dial|ring)\s+(?:me\s+)?(\w+(?:\s+\w+)?)/);
                if (nameMatch) {
                    const name = nameMatch[1];
                    const contact = findContact(name);
                    if (contact) {
                        response = `ðŸ“ž Calling <strong>${contact.name}</strong> at ${contact.phone}`;
                        speakResponse(`Calling ${contact.name}...`);
                        conversationContext.lastContact = contact;
                        
                        // Try actual call on mobile
                        if (/Mobi|Android/i.test(navigator.userAgent)) {
                            window.location.href = `tel:${contact.phone}`;
                        } else {
                            response += `<br><small><i>On mobile, this would initiate a real call.</i></small>`;
                        }
                        
                        handled = true;
                    } else {
                        response = `Contact "${name}" not found. Add contacts in the Contacts tab or say "Add contact ${name}".`;
                        handled = true;
                    }
                }
            }
            
            // Enhanced WhatsApp/SMS
            if (/(whatsapp|sms|text|message)/i.test(lowerCmd)) {
                let contactName = '';
                let message = '';
                
                // Parse different formats
                if (lowerCmd.includes('whatsapp to')) {
                    contactName = command.split('whatsapp to')[1]?.split('saying')[0]?.trim();
                    message = command.split('saying')[1]?.trim();
                } else if (lowerCmd.includes('send whatsapp to')) {
                    contactName = command.split('send whatsapp to')[1]?.split('saying')[0]?.trim();
                    message = command.split('saying')[1]?.trim();
                } else if (lowerCmd.includes('text to') || lowerCmd.includes('sms to')) {
                    contactName = command.split(/(?:text|sms) to/)[1]?.split('saying')[0]?.trim();
                    message = command.split('saying')[1]?.trim();
                }
                
                if (contactName) {
                    const contact = findContact(contactName);
                    if (contact) {
                        if (!message) {
                            message = prompt(`What message to send to ${contactName}?`, "Hello from ALTECH AI!");
                            if (!message) {
                                response = "Message cancelled.";
                                handled = true;
                                return { handled, response };
                            }
                        }
                        
                        const cleanPhone = contact.phone.replace(/\D/g, '');
                        const encodedMessage = encodeURIComponent(message);
                        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                        
                        window.open(whatsappUrl, '_blank');
                        response = `ðŸ’¬ Sending WhatsApp to <strong>${contact.name}</strong>: "${message}"`;
                        speakResponse(`Message sent to ${contact.name}`);
                        handled = true;
                    } else {
                        response = `Contact "${contactName}" not found.`;
                        handled = true;
                    }
                }
            }
            
            // Enhanced note taking
            if (/(add.note|note.that|remember.that|create.note)/i.test(lowerCmd)) {
                let noteContent = '';
                
                // Extract note content
                if (lowerCmd.includes('saying')) {
                    noteContent = command.split('saying')[1]?.trim();
                } else if (lowerCmd.includes('that')) {
                    noteContent = command.split('that')[1]?.trim();
                } else if (lowerCmd.includes('note:')) {
                    noteContent = command.split('note:')[1]?.trim();
                } else {
                    noteContent = command.replace(/(add.note|note.that|remember.that|create.note)/gi, '').trim();
                }
                
                if (noteContent) {
                    addNoteToHistory(noteContent);
                    response = `ðŸ“ Note added: <strong>"${noteContent}"</strong>`;
                    speakResponse(`Note added: ${noteContent.substring(0, 100)}`);
                    handled = true;
                }
            }
            
            // Enhanced reminders with better time parsing
            if (/(remind|reminder|alert|notify)/i.test(lowerCmd)) {
                let task = '';
                let timeText = '';
                
                // Parse task and time
                if (lowerCmd.includes('remind me to')) {
                    task = command.split('remind me to')[1]?.trim();
                } else if (lowerCmd.includes('reminder for')) {
                    task = command.split('reminder for')[1]?.trim();
                } else if (lowerCmd.includes('alert me to')) {
                    task = command.split('alert me to')[1]?.trim();
                }
                
                if (task) {
                    // Advanced time parsing
                    const time = parseNaturalLanguageTime(command);
                    
                    addReminder(task, time.toISOString(), 'medium');
                    const timeStr = time.toLocaleString();
                    response = `â° Reminder set: <strong>${task}</strong><br><small>ðŸ“… Due: ${timeStr}</small>`;
                    speakResponse(`Reminder set for ${task}`);
                    handled = true;
                }
            }
            
            // Enhanced web search
            if (/(search|google|find|look.up)/i.test(lowerCmd)) {
                let query = '';
                
                if (lowerCmd.includes('search for')) {
                    query = command.split('search for')[1]?.trim();
                } else if (lowerCmd.includes('google')) {
                    query = command.split('google')[1]?.trim();
                } else if (lowerCmd.includes('find')) {
                    query = command.split('find')[1]?.trim();
                }
                
                if (query) {
                    response = `ðŸ” Searching: <strong>${query}</strong>`;
                    speakResponse(`Searching for ${query}`);
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                    handled = true;
                }
            }
            
            // Enhanced weather
            if (/(weather|forecast|temperature)/i.test(lowerCmd)) {
                const locationMatch = lowerCmd.match(/(?:weather|forecast)\s+(?:in|at|for)\s+([\w\s,]+)/);
                const location = locationMatch ? locationMatch[1].trim() : '';
                
                if (location) {
                    response = `ðŸŒ¤ï¸ Getting weather for <strong>${location}</strong>...`;
                    speakResponse(`Checking weather for ${location}`);
                    window.open(`https://www.google.com/search?q=weather+${encodeURIComponent(location)}`, '_blank');
                } else {
                    response = `ðŸŒ¤ï¸ Checking current weather...`;
                    speakResponse("Checking weather");
                    window.open('https://www.google.com/search?q=weather', '_blank');
                }
                handled = true;
            }
            
            // Time and date
            if (/(what.time|current.time|time.now)/i.test(lowerCmd)) {
                const time = new Date();
                const timeStr = time.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true 
                });
                const dateStr = time.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                response = `ðŸ•’ Current time: <strong>${timeStr}</strong><br>ðŸ“… Date: <strong>${dateStr}</strong>`;
                speakResponse(`The time is ${timeStr}`);
                handled = true;
            }
            
            // World time
            if (/(time.in|what.time.in)/i.test(lowerCmd)) {
                const locationMatch = lowerCmd.match(/time\s+in\s+([\w\s]+)/);
                if (locationMatch) {
                    const location = locationMatch[1];
                    response = `ðŸŒ Getting time in <strong>${location}</strong>...`;
                    speakResponse(`Checking time in ${location}`);
                    window.open(`https://www.google.com/search?q=time+in+${encodeURIComponent(location)}`, '_blank');
                    handled = true;
                }
            }
            
            return { handled, response };
        }

        function parseNaturalLanguageTime(command) {
            const now = new Date();
            const time = new Date(now);
            const lowerCmd = command.toLowerCase();
            
            // Tomorrow
            if (lowerCmd.includes('tomorrow')) {
                time.setDate(time.getDate() + 1);
            }
            
            // Next week
            if (lowerCmd.includes('next week')) {
                time.setDate(time.getDate() + 7);
            }
            
            // In X hours/days/weeks
            const hourMatch = lowerCmd.match(/in\s+(\d+)\s+hour/);
            if (hourMatch) {
                time.setHours(time.getHours() + parseInt(hourMatch[1]));
            }
            
            const dayMatch = lowerCmd.match(/in\s+(\d+)\s+day/);
            if (dayMatch) {
                time.setDate(time.getDate() + parseInt(dayMatch[1]));
            }
            
            const weekMatch = lowerCmd.match(/in\s+(\d+)\s+week/);
            if (weekMatch) {
                time.setDate(time.getDate() + (parseInt(weekMatch[1]) * 7));
            }
            
            // Specific time today
            const timeMatch = lowerCmd.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                const period = timeMatch[3]?.toLowerCase();
                
                if (period === 'pm' && hours < 12) hours += 12;
                if (period === 'am' && hours === 12) hours = 0;
                
                time.setHours(hours, minutes, 0, 0);
                
                // If time has passed today, set for tomorrow
                if (time < now) {
                    time.setDate(time.getDate() + 1);
                }
            }
            
            return time;
        }

        function formatAIResponse(aiResponse, originalCommand) {
            return `
                <div class="ai-response-content">
                    <div class="ai-response-item">
                        <strong>ðŸŽ¯ You said:</strong>
                        <p>"${originalCommand}"</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ¤– AI Response:</strong>
                        <p>${aiResponse}</p>
                    </div>
                </div>
            `;
        }

        // ================ ENHANCED CONTACT MANAGEMENT ================
        function findContact(nameQuery) {
            return myContacts.find(c => 
                c.name.toLowerCase().includes(nameQuery.toLowerCase()) ||
                c.phone.includes(nameQuery)
            );
        }

        function searchContacts(query) {
            const list = document.getElementById('contactsList');
            if (!query.trim()) {
                renderContacts();
                return;
            }
            
            const filtered = myContacts.filter(contact =>
                contact.name.toLowerCase().includes(query.toLowerCase()) ||
                contact.phone.includes(query) ||
                (contact.email && contact.email.toLowerCase().includes(query.toLowerCase()))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No contacts found.</p>';
                return;
            }
            
            list.innerHTML = filtered.map(contact => `
                <div class="contact-item" onclick="selectContact('${contact.name}')" 
                     oncontextmenu="showContextMenu(event, '${contact.name}'); return false;">
                    <div class="contact-avatar">${contact.name.charAt(0).toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-phone">${contact.phone}</div>
                        ${contact.email ? `<div class="contact-email" style="font-size: 0.9rem; color: var(--text-secondary);">${contact.email}</div>` : ''}
                    </div>
                    <div class="contact-actions">
                        <button class="control-btn" onclick="callContact('${contact.name}')" title="Call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="control-btn" onclick="whatsappContact('${contact.name}')" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function trySyncContacts() {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel', 'email'];
                    const opts = { multiple: true };
                    
                    const contacts = await navigator.contacts.select(props, opts);
                    
                    if (contacts.length) {
                        let addedCount = 0;
                        contacts.forEach(c => {
                            if (c.tel && c.tel.length > 0 && c.name && c.name.length > 0) {
                                const exists = myContacts.some(existing => 
                                    existing.name === c.name[0] && existing.phone === c.tel[0]
                                );
                                if (!exists) {
                                    myContacts.push({ 
                                        name: c.name[0], 
                                        phone: c.tel[0],
                                        email: c.email ? c.email[0] : ''
                                    });
                                    addedCount++;
                                }
                            }
                        });
                        
                        saveContacts();
                        renderContacts();
                        showNotification(`âœ… Synced ${addedCount} new contacts`, 'success');
                        updateAIResponse(`âœ… Synced ${addedCount} new contacts from device`);
                    } else {
                        showNotification('No contacts selected', 'info');
                    }
                } catch (error) {
                    console.error('Contact sync error:', error);
                    showNotification('âš ï¸ Contact sync not available', 'error');
                }
            } else {
                showNotification('âš ï¸ Contact API not supported', 'warning');
            }
        }

        function showAddContactModal() {
            document.getElementById('addContactModalOverlay').style.display = 'block';
            document.getElementById('addContactModal').style.display = 'block';
            document.getElementById('newContactName').focus();
        }

        function addNewContact() {
            const name = document.getElementById('newContactName').value.trim();
            const phone = document.getElementById('newContactPhone').value.trim();
            const email = document.getElementById('newContactEmail').value.trim();
            
            if (name && phone) {
                // Enhanced phone validation
                const phoneRegex = /^[\d\s\+\-\(\)]{10,}$/;
                if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                    showNotification('Please enter a valid phone number (minimum 10 digits)', 'error');
                    return;
                }
                
                // Email validation if provided
                if (email && !isValidEmail(email)) {
                    showNotification('Please enter a valid email address', 'error');
                    return;
                }
                
                myContacts.push({ name, phone, email });
                saveContacts();
                renderContacts();
                closeModal('addContactModal');
                showNotification(`âœ… Added contact: ${name}`, 'success');
                updateAIResponse(`âœ… Added contact: <strong>${name}</strong>`);
            } else {
                showNotification('Please enter both name and phone number', 'error');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function saveContacts() {
            localStorage.setItem('altech_contacts', JSON.stringify(myContacts));
            updateStats();
        }

        function renderContacts() {
            const list = document.getElementById('contactsList');
            if (myContacts.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No contacts yet. Add your first contact!</p>';
                return;
            }
            
            list.innerHTML = myContacts.map(contact => `
                <div class="contact-item" onclick="selectContact('${contact.name}')" 
                     oncontextmenu="showContextMenu(event, '${contact.name}'); return false;">
                    <div class="contact-avatar">${contact.name.charAt(0).toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-phone">${contact.phone}</div>
                        ${contact.email ? `<div class="contact-email" style="font-size: 0.9rem; color: var(--text-secondary);">${contact.email}</div>` : ''}
                    </div>
                    <div class="contact-actions">
                        <button class="control-btn" onclick="event.stopPropagation(); callContact('${contact.name}')" title="Call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="control-btn" onclick="event.stopPropagation(); whatsappContact('${contact.name}')" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function selectContact(contactName) {
            const contact = findContact(contactName);
            if (contact) {
                selectedContact = contact;
                updateAIResponse(`
                    <div class="ai-response-content">
                        <div class="ai-response-item">
                            <strong>ðŸ‘¤ Selected Contact:</strong>
                            <p><strong>Name:</strong> ${contact.name}</p>
                            <p><strong>Phone:</strong> ${contact.phone}</p>
                            ${contact.email ? `<p><strong>Email:</strong> ${contact.email}</p>` : ''}
                        </div>
                        <div class="ai-response-item">
                            <strong>ðŸ“ž Actions:</strong>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="action-btn" onclick="callContact('${contact.name}')">
                                    <i class="fas fa-phone"></i> Call
                                </button>
                                <button class="action-btn" onclick="whatsappContact('${contact.name}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="action-btn" onclick="sendEmailToContact('${contact.name}')">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            }
        }

        function showContextMenu(event, contactName) {
            event.preventDefault();
            selectedContact = findContact(contactName);
            
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${event.pageX}px`;
            contextMenu.style.top = `${event.pageY}px`;
            contextMenuVisible = true;
            
            // Close context menu when clicking elsewhere
            document.addEventListener('click', closeContextMenu);
        }

        function closeContextMenu() {
            if (contextMenuVisible) {
                document.getElementById('contextMenu').style.display = 'none';
                contextMenuVisible = false;
                document.removeEventListener('click', closeContextMenu);
            }
        }

        function callSelectedContact() {
            if (selectedContact) {
                callContact(selectedContact.name);
                closeContextMenu();
            }
        }

        function messageSelectedContact() {
            if (selectedContact) {
                const message = prompt(`Send SMS to ${selectedContact.name}:`, "Hello!");
                if (message) {
                    // SMS URL scheme
                    window.open(`sms:${selectedContact.phone}&body=${encodeURIComponent(message)}`, '_blank');
                    showNotification(`ðŸ“± SMS sent to ${selectedContact.name}`, 'success');
                }
                closeContextMenu();
            }
        }

        function whatsappSelectedContact() {
            if (selectedContact) {
                whatsappContact(selectedContact.name);
                closeContextMenu();
            }
        }

        function emailSelectedContact() {
            if (selectedContact && selectedContact.email) {
                window.open(`mailto:${selectedContact.email}`, '_blank');
                closeContextMenu();
            } else {
                showNotification('No email address for this contact', 'error');
            }
        }

        function editSelectedContact() {
            if (selectedContact) {
                // Implement edit functionality
                const newName = prompt('Edit name:', selectedContact.name);
                const newPhone = prompt('Edit phone:', selectedContact.phone);
                const newEmail = prompt('Edit email:', selectedContact.email || '');
                
                if (newName && newPhone) {
                    selectedContact.name = newName;
                    selectedContact.phone = newPhone;
                    if (newEmail) selectedContact.email = newEmail;
                    saveContacts();
                    renderContacts();
                    showNotification('âœ… Contact updated', 'success');
                }
                closeContextMenu();
            }
        }

        function deleteSelectedContact() {
            if (selectedContact) {
                if (confirm(`Delete contact ${selectedContact.name}?`)) {
                    myContacts = myContacts.filter(c => c.name !== selectedContact.name);
                    saveContacts();
                    renderContacts();
                    showNotification(`ðŸ—‘ï¸ Contact ${selectedContact.name} deleted`, 'success');
                    updateAIResponse(`ðŸ—‘ï¸ Contact <strong>${selectedContact.name}</strong> deleted`);
                }
                closeContextMenu();
            }
        }

        function callContact(contactName) {
            const contact = findContact(contactName);
            if (contact) {
                if (confirm(`Call ${contact.name} at ${contact.phone}?`)) {
                    conversationContext.lastContact = contact;
                    
                    // Try actual call
                    if (/Mobi|Android/i.test(navigator.userAgent)) {
                        window.location.href = `tel:${contact.phone}`;
                    } else {
                        updateAIResponse(`ðŸ“ž Would call: <strong>${contact.name}</strong> at ${contact.phone}<br><small><i>On mobile, this would initiate a real call.</i></small>`);
                        speakResponse(`Calling ${contact.name}`);
                    }
                }
            }
        }

        function whatsappContact(contactName) {
            const contact = findContact(contactName);
            if (contact) {
                const message = prompt(`WhatsApp message to ${contact.name}:`, "Hello!");
                if (message) {
                    const cleanPhone = contact.phone.replace(/\D/g, '');
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    showNotification(`ðŸ’¬ WhatsApp sent to ${contact.name}`, 'success');
                }
            }
        }

        function sendEmailToContact(contactName) {
            const contact = findContact(contactName);
            if (contact && contact.email) {
                const subject = prompt('Email subject:', 'Hello from ALTECH AI');
                const body = prompt('Email message:', 'Hello!');
                
                if (subject && body) {
                    const mailtoLink = `mailto:${contact.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, '_blank');
                    showNotification(`ðŸ“§ Email sent to ${contact.name}`, 'success');
                }
            } else {
                showNotification('No email address for this contact', 'error');
            }
        }

        // ================ ENHANCED REMINDERS ================
        function showAddReminderModal() {
            const now = new Date();
            const timeInput = document.getElementById('newReminderTime');
            timeInput.value = now.toISOString().slice(0, 16);
            document.getElementById('addReminderModalOverlay').style.display = 'block';
            document.getElementById('addReminderModal').style.display = 'block';
            document.getElementById('newReminderText').focus();
        }

        function addNewReminder() {
            const text = document.getElementById('newReminderText').value.trim();
            const time = document.getElementById('newReminderTime').value;
            const priority = document.getElementById('reminderPriority').value;
            
            if (text && time) {
                addReminder(text, time, priority);
                closeModal('addReminderModal');
                showNotification('âœ… Reminder added', 'success');
            } else {
                showNotification('Please enter reminder text and time', 'error');
            }
        }

        function addReminder(task, time, priority = 'medium') {
            const reminder = {
                id: Date.now(),
                task: task,
                time: time,
                created: new Date().toISOString(),
                priority: priority,
                completed: false
            };
            reminders.push(reminder);
            saveReminders();
            renderReminders();
            
            // Schedule notification
            scheduleReminderNotification(reminder);
        }

        function saveReminders() {
            localStorage.setItem('altech_reminders', JSON.stringify(reminders));
            updateStats();
        }

        function renderReminders() {
            const list = document.getElementById('remindersList');
            if (reminders.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No reminders yet. Add your first reminder!</p>';
                return;
            }
            
            const now = new Date();
            list.innerHTML = reminders
                .filter(r => !r.completed)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .map(reminder => {
                    const time = new Date(reminder.time);
                    const isDue = time <= now;
                    const timeUntil = Math.floor((time - now) / (1000 * 60)); // Minutes until
                    
                    let priorityColor = 'var(--success)';
                    if (reminder.priority === 'high') priorityColor = 'var(--danger)';
                    if (reminder.priority === 'medium') priorityColor = 'var(--warning)';
                    
                    return `
                        <div class="reminder-item ${isDue ? 'due' : ''}" style="border-left-color: ${priorityColor}">
                            <div class="reminder-text">${reminder.task}</div>
                            <div class="reminder-time">
                                <i class="fas fa-clock"></i>
                                ${time.toLocaleString()}
                                <span style="margin-left: 10px; padding: 2px 8px; background: ${priorityColor}; color: white; border-radius: 12px; font-size: 0.8rem;">
                                    ${reminder.priority.toUpperCase()}
                                </span>
                                ${timeUntil > 0 ? `<span style="margin-left: 10px; color: var(--text-secondary);">(in ${timeUntil} minutes)</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="completeReminder(${reminder.id})" style="background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: var(--radius-sm); cursor: pointer;">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                <button onclick="snoozeReminder(${reminder.id})" style="background: var(--info); color: white; border: none; padding: 8px 15px; border-radius: var(--radius-sm); cursor: pointer;">
                                    <i class="fas fa-clock"></i> Snooze
                                </button>
                                <button onclick="deleteReminder(${reminder.id})" style="background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: var(--radius-sm); cursor: pointer;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function completeReminder(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.completed = true;
                reminder.completedAt = new Date().toISOString();
                saveReminders();
                renderReminders();
                showNotification('âœ… Reminder completed', 'success');
                speakResponse(`Reminder completed: ${reminder.task}`);
            }
        }

        function snoozeReminder(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                const newTime = new Date(new Date(reminder.time).getTime() + 30 * 60000); // Snooze for 30 minutes
                reminder.time = newTime.toISOString();
                saveReminders();
                renderReminders();
                showNotification('â° Reminder snoozed for 30 minutes', 'info');
                speakResponse(`Snoozed reminder for 30 minutes`);
            }
        }

        function deleteReminder(id) {
            if (confirm('Delete this reminder?')) {
                reminders = reminders.filter(r => r.id !== id);
                saveReminders();
                renderReminders();
                showNotification('ðŸ—‘ï¸ Reminder deleted', 'success');
            }
        }

        function scheduleReminderNotification(reminder) {
            const reminderTime = new Date(reminder.time);
            const now = new Date();
            const timeUntil = reminderTime - now;
            
            if (timeUntil > 0) {
                setTimeout(() => {
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification('ALTECH Reminder', {
                            body: reminder.task,
                            icon: 'https://cdn-icons-png.flaticon.com/512/3448/3448737.png',
                            tag: `reminder-${reminder.id}`
                        });
                    }
                    
                    // Speak reminder if voice feedback is enabled
                    if (document.getElementById('voiceFeedback')?.checked) {
                        speakResponse(`Reminder: ${reminder.task}`);
                    }
                    
                    // Update UI
                    showNotification(`â° Reminder: ${reminder.task}`, 'warning');
                }, timeUntil);
            }
        }

        function checkReminders() {
            const now = new Date();
            const dueReminders = reminders.filter(r => 
                !r.completed && new Date(r.time) <= now
            );
            
            if (dueReminders.length > 0) {
                dueReminders.forEach(reminder => {
                    showNotification(`â° Reminder: ${reminder.task}`, 'warning');
                    if (document.getElementById('voiceFeedback')?.checked) {
                        speakResponse(`Reminder: ${reminder.task}`);
                    }
                });
                
                renderReminders();
            }
        }

        // ================ ENHANCED NOTES ================
        function saveNotes() {
            const notes = quickNotesEl.value;
            localStorage.setItem('quickNotes', notes);
            
            // Add to history if not empty
            const lines = notes.trim().split('\n').filter(line => line.trim());
            if (lines.length > 0) {
                const lastLine = lines[lines.length - 1];
                if (lastLine && lastLine.trim()) {
                    addNoteToHistory(lastLine.trim());
                }
            }
            
            showNotification('ðŸ“ Notes saved', 'success');
        }

        function loadNotes() {
            quickNotesEl.value = localStorage.getItem('quickNotes') || '';
        }

        function clearNotes() {
            if (confirm('Clear all notes?')) {
                quickNotesEl.value = '';
                saveNotes();
                showNotification('ðŸ—‘ï¸ All notes cleared', 'success');
            }
        }

        function exportNotes() {
            const notes = quickNotesEl.value;
            if (notes.trim()) {
                const blob = new Blob([notes], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `altech-notes-${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                showNotification('âœ… Notes exported', 'success');
            } else {
                showNotification('No notes to export', 'warning');
            }
        }

        function addNoteToHistory(note) {
            notesHistory.push({
                id: Date.now(),
                text: note,
                time: new Date().toISOString(),
                type: 'manual'
            });
            
            if (notesHistory.length > 50) {
                notesHistory = notesHistory.slice(-50);
            }
            
            localStorage.setItem('altech_notes_history', JSON.stringify(notesHistory));
            renderNotesHistory();
            updateStats();
        }

        function renderNotesHistory() {
            const container = document.getElementById('notesHistory');
            if (notesHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No recent notes. Start by adding a note!</p>';
                return;
            }
            
            container.innerHTML = notesHistory.slice().reverse().map(note => `
                <div class="note-item">
                    <div class="note-content">${note.text}</div>
                    <div class="note-time">
                        <i class="fas fa-clock"></i>
                        ${new Date(note.time).toLocaleString()}
                        ${note.type === 'voice' ? '<i class="fas fa-microphone" style="margin-left: 10px;"></i>' : ''}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="editNote(${note.id})" style="background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteNote(${note.id})" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editNote(id) {
            const note = notesHistory.find(n => n.id === id);
            if (note) {
                const newText = prompt('Edit note:', note.text);
                if (newText !== null) {
                    note.text = newText;
                    note.edited = new Date().toISOString();
                    localStorage.setItem('altech_notes_history', JSON.stringify(notesHistory));
                    renderNotesHistory();
                    showNotification('ðŸ“ Note updated', 'success');
                }
            }
        }

        function deleteNote(id) {
            if (confirm('Delete this note?')) {
                notesHistory = notesHistory.filter(n => n.id !== id);
                localStorage.setItem('altech_notes_history', JSON.stringify(notesHistory));
                renderNotesHistory();
                showNotification('ðŸ—‘ï¸ Note deleted', 'success');
            }
        }

        function refreshNotes() {
            renderNotesHistory();
            showNotification('ðŸ”„ Notes refreshed', 'info');
        }

        // ================ SEARCH FUNCTIONALITY ================
        function performSearch() {
            const query = document.getElementById('webSearch').value.trim();
            if (query) {
                updateAIResponse(`ðŸ” Searching for: <strong>${query}</strong>`);
                speakResponse(`Searching for ${query}`);
                
                // Open search in new tab
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                
                // Also search locally
                searchLocally(query);
            } else {
                showNotification('Please enter a search query', 'warning');
            }
        }

        function searchWikipedia() {
            const query = document.getElementById('webSearch').value.trim();
            if (query) {
                window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(query)}`, '_blank');
                showNotification(`ðŸ” Searching Wikipedia for ${query}`, 'info');
            }
        }

        function searchNews() {
            const query = document.getElementById('webSearch').value.trim();
            if (query) {
                window.open(`https://news.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                showNotification(`ðŸ“° Searching news for ${query}`, 'info');
            }
        }

        function searchImages() {
            const query = document.getElementById('webSearch').value.trim();
            if (query) {
                window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank');
                showNotification(`ðŸ–¼ï¸ Searching images for ${query}`, 'info');
            }
        }

        function searchVideos() {
            const query = document.getElementById('webSearch').value.trim();
            if (query) {
                window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`, '_blank');
                showNotification(`ðŸŽ¥ Searching videos for ${query}`, 'info');
            }
        }

        function searchLocally(query) {
            const lowerQuery = query.toLowerCase();
            const results = {
                contacts: myContacts.filter(c => 
                    c.name.toLowerCase().includes(lowerQuery) ||
                    c.phone.includes(query) ||
                    (c.email && c.email.toLowerCase().includes(lowerQuery))
                ),
                notes: notesHistory.filter(n => 
                    n.text.toLowerCase().includes(lowerQuery)
                ),
                reminders: reminders.filter(r => 
                    r.task.toLowerCase().includes(lowerQuery)
                )
            };
            
            const resultsContainer = document.getElementById('resultsContainer');
            let html = '<h3 style="margin-bottom: 20px; color: var(--primary);">Local Search Results</h3>';
            
            if (results.contacts.length > 0) {
                html += `<div style="margin-bottom: 25px;">
                    <h4><i class="fas fa-users"></i> Contacts (${results.contacts.length})</h4>
                    ${results.contacts.map(c => `
                        <div style="padding: 10px; background: var(--primary-light); border-radius: var(--radius-sm); margin: 5px 0;">
                            <strong>${c.name}</strong><br>
                            ðŸ“ž ${c.phone} ${c.email ? `<br>ðŸ“§ ${c.email}` : ''}
                        </div>
                    `).join('')}
                </div>`;
            }
            
            if (results.notes.length > 0) {
                html += `<div style="margin-bottom: 25px;">
                    <h4><i class="fas fa-sticky-note"></i> Notes (${results.notes.length})</h4>
                    ${results.notes.slice(0, 5).map(n => `
                        <div style="padding: 10px; background: var(--info-light); border-radius: var(--radius-sm); margin: 5px 0;">
                            ${n.text}<br>
                            <small>${new Date(n.time).toLocaleString()}</small>
                        </div>
                    `).join('')}
                </div>`;
            }
            
            if (results.reminders.length > 0) {
                html += `<div style="margin-bottom: 25px;">
                    <h4><i class="fas fa-bell"></i> Reminders (${results.reminders.length})</h4>
                    ${results.reminders.slice(0, 5).map(r => `
                        <div style="padding: 10px; background: var(--warning-light); border-radius: var(--radius-sm); margin: 5px 0;">
                            ${r.task}<br>
                            <small>â° ${new Date(r.time).toLocaleString()}</small>
                        </div>
                    `).join('')}
                </div>`;
            }
            
            if (results.contacts.length === 0 && results.notes.length === 0 && results.reminders.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No local results found.</p>';
            }
            
            resultsContainer.innerHTML = html;
        }

        // ================ QUICK ACTIONS ================
        function quickAction(action) {
            switch(action) {
                case 'call_last':
                    if (conversationContext.lastContact) {
                        if (confirm(`Call ${conversationContext.lastContact.name}?`)) {
                            updateAIResponse(`ðŸ“ž Calling ${conversationContext.lastContact.name}`);
                            if (/Mobi|Android/i.test(navigator.userAgent)) {
                                window.location.href = `tel:${conversationContext.lastContact.phone}`;
                            }
                        }
                    } else {
                        showNotification('No recent contact found', 'warning');
                    }
                    break;
                    
                case 'add_note':
                    const note = prompt("Enter quick note:");
                    if (note) {
                        addNoteToHistory(note);
                        updateAIResponse(`ðŸ“ Note added: ${note.substring(0, 100)}...`);
                        showNotification('ðŸ“ Note added', 'success');
                    }
                    break;
                    
                case 'weather':
                    const location = prompt("Enter location for weather:", "");
                    if (location) {
                        window.open(`https://www.google.com/search?q=weather+${encodeURIComponent(location)}`, '_blank');
                        updateAIResponse(`ðŸŒ¤ï¸ Checking weather for ${location}...`);
                    } else {
                        window.open('https://www.google.com/search?q=weather', '_blank');
                        updateAIResponse(`ðŸŒ¤ï¸ Checking current weather...`);
                    }
                    break;
                    
                case 'search':
                    const query = prompt("What would you like to search for?", "");
                    if (query) {
                        window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                        updateAIResponse(`ðŸ” Searching: ${query}`);
                    }
                    break;
                    
                case 'joke':
                    tellJoke();
                    break;
                    
                case 'quote':
                    getQuote();
                    break;
                    
                case 'time':
                    const time = new Date();
                    const timeStr = time.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true 
                    });
                    const dateStr = time.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    speakResponse(`The time is ${timeStr} on ${dateStr}`);
                    updateAIResponse(`ðŸ•’ Current time: <strong>${timeStr}</strong><br>ðŸ“… Date: <strong>${dateStr}</strong>`);
                    break;
                    
                case 'message':
                    showAddContactModal();
                    break;
                    
                case 'email':
                    const email = prompt("Enter email address:", "");
                    const subject = prompt("Enter subject:", "Hello from ALTECH AI");
                    const body = prompt("Enter message:", "Hello!");
                    
                    if (email && subject && body) {
                        window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                        showNotification('ðŸ“§ Email ready to send', 'success');
                    }
                    break;
            }
        }

        async function tellJoke() {
            try {
                const response = await fetch('https://v2.jokeapi.dev/joke/Any?type=single');
                const data = await response.json();
                const joke = data.joke || "Why don't scientists trust atoms? Because they make up everything!";
                speakResponse(joke);
                updateAIResponse(`ðŸ˜‚ ${joke}`);
                showNotification('ðŸ˜‚ Here\'s a joke!', 'info');
            } catch {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "What do you call a fake noodle? An impasta!",
                    "Why did the scarecrow win an award? He was outstanding in his field!"
                ];
                const joke = jokes[Math.floor(Math.random() * jokes.length)];
                speakResponse(joke);
                updateAIResponse(`ðŸ˜‚ ${joke}`);
            }
        }

        async function getQuote() {
            try {
                const response = await fetch('https://api.quotable.io/random');
                const data = await response.json();
                const quote = `"${data.content}" - ${data.author}`;
                speakResponse(quote);
                updateAIResponse(`ðŸ’­ ${quote}`);
                showNotification('ðŸ’­ Daily quote', 'info');
            } catch {
                const quotes = [
                    '"The only way to do great work is to love what you do." - Steve Jobs',
                    '"Innovation distinguishes between a leader and a follower." - Steve Jobs',
                    '"The future belongs to those who believe in the beauty of their dreams." - Eleanor Roosevelt'
                ];
                const quote = quotes[Math.floor(Math.random() * quotes.length)];
                speakResponse(quote);
                updateAIResponse(`ðŸ’­ ${quote}`);
            }
        }

        // ================ SETTINGS MANAGEMENT ================
        function loadSettings() {
            settings = JSON.parse(localStorage.getItem('altech_settings') || '{}');
            
            // Apply settings
            if (settings.voiceSpeed) voiceSpeed = settings.voiceSpeed;
            if (settings.aiProvider) currentAIProvider = settings.aiProvider;
            if (settings.aiEnabled !== undefined) aiEnabled = settings.aiEnabled;
            if (settings.wakeWordEnabled !== undefined) wakeWordEnabled = settings.wakeWordEnabled;
            
            // Update UI elements
            if (document.getElementById('voiceSpeed')) {
                document.getElementById('voiceSpeed').value = voiceSpeed;
                updateVoiceSpeed(voiceSpeed);
            }
            if (document.getElementById('aiProvider')) {
                document.getElementById('aiProvider').value = currentAIProvider;
            }
            if (document.getElementById('voiceFeedback')) {
                document.getElementById('voiceFeedback').checked = settings.voiceFeedback !== false;
            }
            if (document.getElementById('wakeWord')) {
                document.getElementById('wakeWord').checked = wakeWordEnabled;
            }
            if (document.getElementById('autoSave')) {
                document.getElementById('autoSave').checked = settings.autoSave !== false;
            }
            if (document.getElementById('enableNotifications')) {
                document.getElementById('enableNotifications').checked = settings.enableNotifications !== false;
            }
            if (document.getElementById('darkModeAuto')) {
                document.getElementById('darkModeAuto').checked = settings.darkModeAuto !== false;
            }
            if (document.getElementById('localStorage')) {
                document.getElementById('localStorage').checked = settings.localStorage !== false;
            }
            if (document.getElementById('clearOnExit')) {
                document.getElementById('clearOnExit').checked = settings.clearOnExit !== false;
            }
        }

        function saveSettings() {
            settings.voiceSpeed = parseFloat(document.getElementById('voiceSpeed').value);
            settings.aiProvider = document.getElementById('aiProvider').value;
            settings.voiceFeedback = document.getElementById('voiceFeedback').checked;
            settings.wakeWordEnabled = document.getElementById('wakeWord').checked;
            settings.autoSave = document.getElementById('autoSave').checked;
            settings.enableNotifications = document.getElementById('enableNotifications').checked;
            settings.darkModeAuto = document.getElementById('darkModeAuto').checked;
            settings.localStorage = document.getElementById('localStorage').checked;
            settings.clearOnExit = document.getElementById('clearOnExit').checked;
            
            localStorage.setItem('altech_settings', JSON.stringify(settings));
            showNotification('âœ… Settings saved', 'success');
            
            // Apply settings
            wakeWordEnabled = settings.wakeWordEnabled;
            voiceSpeed = settings.voiceSpeed;
            currentAIProvider = settings.aiProvider;
            
            updateVoiceSpeed(voiceSpeed);
            updateAIStatus();
        }

        function showSettings() {
            document.getElementById('settingsModalOverlay').style.display = 'block';
            document.getElementById('settingsModal').style.display = 'block';
        }

        function resetSettings() {
            if (confirm('Reset all settings to default?')) {
                localStorage.removeItem('altech_settings');
                settings = {};
                loadSettings();
                showNotification('âœ… Settings reset to default', 'success');
            }
        }

        function clearBrowserCache() {
            if (confirm('Clear browser cache? This will remove temporary files but keep your data.')) {
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                showNotification('ðŸ—‘ï¸ Browser cache cleared', 'success');
            }
        }

        // ================ DATA MANAGEMENT ================
        function exportData() {
            const data = {
                version: '3.0',
                exportDate: new Date().toISOString(),
                contacts: myContacts,
                reminders: reminders,
                notes: {
                    quickNotes: localStorage.getItem('quickNotes'),
                    history: notesHistory
                },
                history: conversationHistory,
                settings: settings,
                stats: {
                    contactCount: myContacts.length,
                    reminderCount: reminders.length,
                    noteCount: notesHistory.length,
                    aiResponseCount: aiResponseCount
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `altech-ai-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            showNotification('âœ… Data exported successfully', 'success');
            updateAIResponse('âœ… All data exported successfully');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate import data
                        if (data.version && data.exportDate) {
                            if (confirm(`Import data from ${new Date(data.exportDate).toLocaleDateString()}? This will merge with existing data.`)) {
                                // Merge data
                                if (data.contacts) myContacts = [...myContacts, ...data.contacts];
                                if (data.reminders) reminders = [...reminders, ...data.reminders];
                                if (data.notes) {
                                    if (data.notes.quickNotes) {
                                        localStorage.setItem('quickNotes', data.notes.quickNotes);
                                    }
                                    if (data.notes.history) {
                                        notesHistory = [...notesHistory, ...data.notes.history];
                                    }
                                }
                                if (data.history) {
                                    conversationHistory = [...conversationHistory, ...data.history];
                                }
                                if (data.settings) {
                                    settings = { ...settings, ...data.settings };
                                }
                                
                                // Save everything
                                saveContacts();
                                saveReminders();
                                localStorage.setItem('altech_notes_history', JSON.stringify(notesHistory));
                                localStorage.setItem('altech_history', JSON.stringify(conversationHistory));
                                localStorage.setItem('altech_settings', JSON.stringify(settings));
                                
                                // Refresh UI
                                loadNotes();
                                renderContacts();
                                renderReminders();
                                renderNotesHistory();
                                renderCommandHistory();
                                loadSettings();
                                
                                showNotification('âœ… Data imported successfully', 'success');
                                updateAIResponse('âœ… Data imported successfully');
                            }
                        } else {
                            showNotification('Invalid backup file', 'error');
                        }
                    } catch (error) {
                        showNotification('Error importing data', 'error');
                        console.error('Import error:', error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('âš ï¸ ARE YOU SURE?\n\nThis will delete ALL data including contacts, reminders, notes, and settings. This action cannot be undone.')) {
                localStorage.clear();
                myContacts = [];
                reminders = [];
                conversationHistory = [];
                notesHistory = [];
                aiResponseCount = 0;
                settings = {};
                
                // Reload app
                location.reload();
            }
        }

        function autoBackup() {
            const lastBackup = localStorage.getItem('lastBackup');
            const now = Date.now();
            
            if (!lastBackup || (now - parseInt(lastBackup)) > 24 * 60 * 60 * 1000) {
                // Create automatic backup
                const backup = {
                    version: '3.0',
                    backupDate: new Date().toISOString(),
                    contacts: myContacts,
                    reminders: reminders,
                    notes: localStorage.getItem('quickNotes'),
                    settings: settings
                };
                
                localStorage.setItem('auto_backup', JSON.stringify(backup));
                localStorage.setItem('lastBackup', now.toString());
                console.log('âœ… Auto-backup created');
            }
        }

        // ================ NOTIFICATION SYSTEM ================
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
            
            // Also show browser notification if enabled
            if (type === 'warning' || type === 'error') {
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification('ALTECH AI Assistant', {
                        body: message,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3448/3448737.png'
                    });
                }
            }
        }

        // ================ UTILITY FUNCTIONS ================
        function speakResponse(text) {
            if (document.getElementById('voiceFeedback')?.checked) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = voiceSpeed;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Select a voice
                if (voices.length > 0) {
                    const preferredVoice = voices.find(v => v.lang === 'en-US') || voices[0];
                    utterance.voice = preferredVoice;
                }
                
                synth.speak(utterance);
            }
        }

        function loadVoices() {
            voices = synth.getVoices();
            if (voices.length === 0) {
                synth.onvoiceschanged = () => {
                    voices = synth.getVoices();
                };
            }
        }

        function updateAIResponse(html) {
            aiOutputEl.innerHTML = html;
            aiOutputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function openTab(tabId) {
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // Activate selected tab
            const btn = document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');
            const pane = document.getElementById(tabId);
            if (pane) pane.classList.add('active');
            
            // Special handling for search tab
            if (tabId === 'search') {
                setTimeout(() => document.getElementById('webSearch')?.focus(), 100);
            }
        }

        function speakCommand(command) {
            transcriptEl.textContent = `"${command}"`;
            handleAdvancedCommand(command);
        }

        function updateVoiceSpeed(speed) {
            voiceSpeed = parseFloat(speed);
            localStorage.setItem('voiceSpeed', speed);
            
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                if (speed < 0.8) speedValue.textContent = 'Slow';
                else if (speed > 1.2) speedValue.textContent = 'Fast';
                else speedValue.textContent = 'Normal';
            }
        }

        function updateConversationContext(command) {
            conversationContext.lastAction = command;
            conversationContext.conversationFlow.push({
                command: command,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 20 interactions
            if (conversationContext.conversationFlow.length > 20) {
                conversationContext.conversationFlow.shift();
            }
            
            localStorage.setItem('conversationContext', JSON.stringify(conversationContext));
        }

        function updateStats() {
            document.getElementById('contactCount').textContent = myContacts.length;
            document.getElementById('reminderCount').textContent = reminders.filter(r => !r.completed).length;
            document.getElementById('noteCount').textContent = notesHistory.length;
            document.getElementById('aiResponseCount').textContent = aiResponseCount;
        }

        function addToHistory(command) {
            conversationHistory.push({
                id: Date.now(),
                command: command,
                time: new Date().toISOString(),
                aiProvider: currentAIProvider
            });
            
            if (conversationHistory.length > 20) {
                conversationHistory = conversationHistory.slice(-20);
            }
            
            localStorage.setItem('altech_history', JSON.stringify(conversationHistory));
            renderCommandHistory();
        }

        function renderCommandHistory() {
            const container = document.getElementById('commandHistory');
            if (conversationHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent commands.</p>';
                return;
            }
            
            container.innerHTML = conversationHistory.slice().reverse().map(item => `
                <div style="padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 0.9rem; background: var(--primary-light); border-radius: var(--radius-sm); margin-bottom: 8px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">
                        <i class="fas fa-clock"></i> ${new Date(item.time).toLocaleTimeString()}
                        <span style="float: right; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">
                            ${item.aiProvider}
                        </span>
                    </div>
                    <div>"${item.command.substring(0, 60)}${item.command.length > 60 ? '...' : ''}"</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Clear command history?')) {
                conversationHistory = [];
                localStorage.setItem('altech_history', JSON.stringify(conversationHistory));
                renderCommandHistory();
                showNotification('ðŸ—‘ï¸ Command history cleared', 'success');
            }
        }

        // ================ WHATSAPP INTEGRATION ================
        function toggleWhatsAppModal() {
            const modal = document.getElementById('whatsappModal');
            const overlay = document.getElementById('whatsappModalOverlay');
            
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
                overlay.style.display = 'none';
            } else {
                modal.style.display = 'block';
                overlay.style.display = 'block';
            }
        }

        function closeWhatsAppModal() {
            document.getElementById('whatsappModal').style.display = 'none';
            document.getElementById('whatsappModalOverlay').style.display = 'none';
        }

        function openWhatsApp(type) {
            const messages = {
                help: "Hello, I need help with ALTECH AI Assistant. Can you assist me?",
                feedback: "Hello, here's my feedback about ALTECH AI Assistant: ",
                feature: "Hello, I'd like to suggest a feature for ALTECH AI Assistant: ",
                demo: "Hello, I'd like to schedule a demo call for ALTECH AI Assistant. Please let me know available times."
            };
            
            const message = encodeURIComponent(messages[type] || "Hello, I need assistance with ALTECH AI Assistant.");
            window.open(`https://wa.me/254706389206?text=${message}`, '_blank');
            closeWhatsAppModal();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById(modalId + 'Overlay').style.display = 'none';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal, .modal-overlay').forEach(el => {
                el.style.display = 'none';
            });
        }

        // ================ INTERNET CONNECTION ================
        function checkInternetConnection() {
            const online = navigator.onLine;
            if (online) {
                connectionStatusEl.className = 'status-indicator status-online';
                connectionStatusEl.innerHTML = '<i class="fas fa-wifi"></i> Online';
            } else {
                connectionStatusEl.className = 'status-indicator status-offline';
                connectionStatusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                showNotification('You are offline. Some features may not work.', 'warning');
            }
        }

        function updateConnectionStatus() {
            checkInternetConnection();
        }

        // ================ SERVICE WORKER FOR PWA ================
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registered:', registration);
                }).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            }
        }

        // ================ AUTO-SAVE SETUP ================
        function setupAutoSave() {
            if (document.getElementById('autoSave')?.checked) {
                setInterval(() => {
                    saveNotes();
                    saveContacts();
                    saveReminders();
                    console.log('ðŸ”„ Auto-saved data');
                }, 30000); // Auto-save every 30 seconds
            }
        }

        // ================ HELPER FUNCTIONS ================
        function showTutorial() {
            updateAIResponse(`
                <div class="ai-response-content">
                    <div class="ai-response-item">
                        <strong>ðŸŽ“ ALTECH AI Assistant Tutorial</strong>
                        <p>Welcome to the tutorial! Here's how to use me:</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸŽ¤ Voice Commands:</strong>
                        <ul>
                            <li>"Call [Name]" - Make a phone call</li>
                            <li>"Add note [your note]" - Create a note</li>
                            <li>"Remind me to [task] [time]" - Set a reminder</li>
                            <li>"Search for [query]" - Search the web</li>
                            <li>"Weather in [city]" - Check weather</li>
                            <li>"What time is it?" - Get current time</li>
                            <li>"Send WhatsApp to [name] saying [message]" - Send WhatsApp</li>
                        </ul>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ“± Quick Actions:</strong>
                        <p>Use the quick action buttons for common tasks</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>âš™ï¸ Settings:</strong>
                        <p>Customize voice speed, AI provider, notifications, and more in Settings</p>
                    </div>
                </div>
            `);
            speakResponse("Here's a quick tutorial on how to use me. Check the screen for details.");
        }

        function checkForUpdates() {
            showNotification('Checking for updates...', 'info');
            setTimeout(() => {
                showNotification('You have the latest version!', 'success');
            }, 1500);
        }

        function showPrivacyPolicy() {
            updateAIResponse(`
                <div class="ai-response-content">
                    <div class="ai-response-item">
                        <strong>ðŸ”’ Privacy Policy</strong>
                        <p>Your privacy is important to us. Here's how we handle your data:</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ“Š Data Storage:</strong>
                        <p>All your data (contacts, notes, reminders) is stored locally on your device. We don't send your personal data to any servers.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ¤– AI Processing:</strong>
                        <p>When using AI features, your commands may be processed by third-party AI services. No personal data is included in these requests.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ” Security:</strong>
                        <p>Your data is encrypted in your browser's local storage and is never shared without your explicit permission.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ—‘ï¸ Data Deletion:</strong>
                        <p>You can delete all your data at any time using the "Clear All Data" button in Settings.</p>
                    </div>
                </div>
            `);
        }

        function showTerms() {
            updateAIResponse(`
                <div class="ai-response-content">
                    <div class="ai-response-item">
                        <strong>âš–ï¸ Terms of Use</strong>
                        <p>By using ALTECH AI Assistant, you agree to the following terms:</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>âœ… Appropriate Use:</strong>
                        <p>Use this assistant for legitimate purposes only. Do not use it for illegal activities.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ“ž Calling & Messaging:</strong>
                        <p>You are responsible for any calls or messages sent through this assistant.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ¤– AI Limitations:</strong>
                        <p>The AI may provide inaccurate information. Always verify important information from reliable sources.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ”„ Service Availability:</strong>
                        <p>We strive for 24/7 availability but do not guarantee uninterrupted service.</p>
                    </div>
                    <div class="ai-response-item">
                        <strong>ðŸ“ˆ Improvements:</strong>
                        <p>We continuously improve the assistant and may add/remove features without notice.</p>
                    </div>
                </div>
            `);
        }

        // Initialize app when page loads
        window.addEventListener('load', initAdvancedApp);
        window.addEventListener('online', checkInternetConnection);
        window.addEventListener('offline', checkInternetConnection);
        
        // Prevent accidental page close
        window.addEventListener('beforeunload', (event) => {
            if (settings.clearOnExit) {
                // Clear sensitive data if enabled
                localStorage.removeItem('conversationContext');
            }
            
            // Auto-save before leaving
            saveNotes();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            // Ctrl/Cmd + / to focus search
            if ((event.ctrlKey || event.metaKey) && event.key === '/') {
                event.preventDefault();
                openTab('search');
                setTimeout(() => document.getElementById('webSearch')?.focus(), 100);
            }
            
            // Ctrl/Cmd + M to toggle microphone
            if ((event.ctrlKey || event.metaKey) && event.key === 'm') {
                event.preventDefault();
                toggleListening();
            }
            
            // Ctrl/Cmd + D to toggle dark mode
            if ((event.ctrlKey || event.metaKey) && event.key === 'd') {
                event.preventDefault();
                toggleTheme();
            }
            
            // Escape to close modals
            if (event.key === 'Escape') {
                closeAllModals();
                closeContextMenu();
            }
        });

        // Context menu handling
        document.addEventListener('contextmenu', (event) => {
            // Prevent default context menu on our elements
            if (event.target.closest('.contact-item, .note-item, .reminder-item')) {
                event.preventDefault();
            }
        });

        // Initialize with a friendly message
        console.log(`
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘     ALTECH AI Assistant v3.0 Loaded!     â•‘
        â•‘                                          â•‘
        â•‘  ðŸ¤– Advanced AI Assistant                â•‘
        â•‘  ðŸŽ¯ Natural Language Understanding       â•‘
        â•‘  ðŸ”’ Privacy-First Design                 â•‘
        â•‘  âš¡ Lightning Fast Performance           â•‘
        â•‘                                          â•‘
        â•‘  Ready to assist you with:               â•‘
        â•‘  ðŸ“ž Calls | ðŸ’¬ Messages | ðŸ“ Notes      â•‘
        â•‘  â° Reminders | ðŸ” Search | ðŸŒ¤ï¸ Weather  â•‘
        â•‘  ðŸ•’ Time | ðŸŽµ Music | ðŸ“§ Email           â•‘
        â•‘                                          â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `);
    </script>
</body>
</html>
